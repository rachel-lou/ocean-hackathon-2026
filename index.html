import { useState, useCallback, useRef } from "react";
import {
  AreaChart, Area, LineChart, Line, BarChart, Bar,
  XAxis, YAxis, Tooltip as RTooltip, ResponsiveContainer,
  CartesianGrid, Legend, ReferenceLine
} from "recharts";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOCK DATA ‚Äî replace block with API; structure preserved
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CELLS = ["A","B","C","D","E","F"];

const SITES = {
  caspar: {
    id:"caspar", name:"Caspar Cove", lat:39.357, lng:-123.818, depthRange:"8‚Äì42 ft",
    canopy:[
      {month:"Jan 22",ha:0.2},{month:"Apr 22",ha:0.3},{month:"Jul 22",ha:0.3},{month:"Oct 22",ha:0.35},
      {month:"Jan 23",ha:0.4},{month:"Apr 23",ha:0.5},{month:"Jul 23",ha:1.1},{month:"Oct 23",ha:2.3},
      {month:"Jan 24",ha:3.8},{month:"Apr 24",ha:5.1},{month:"Jun 24",ha:5.6},
    ],
    // canopyDied: periods where kelp cover fell (for gray overlay on replay)
    canopyDied:[{start:"Jan 22",end:"Apr 23",ha:0.3}],
    dives:[
      {date:"2023-02-11",divers:6,bottomTime:52,maxDepth:28,waterTemp:52,visibility:18,surge:"moderate",cells:{A:180,B:130},comments:"Dense barren in A. Great vis, mild surge.",exitConditions:"Good"},
      {date:"2023-03-04",divers:8,bottomTime:48,maxDepth:32,waterTemp:51,visibility:22,surge:"light",cells:{A:220,B:200},comments:"Kelp recruits spotted at NW edge Cell A.",exitConditions:"Excellent"},
      {date:"2023-04-22",divers:7,bottomTime:55,maxDepth:30,waterTemp:53,visibility:20,surge:"light",cells:{A:195,C:200},comments:"Expanded push into C. Rocky substrate exposed.",exitConditions:"Good"},
      {date:"2023-06-10",divers:5,bottomTime:50,maxDepth:26,waterTemp:55,visibility:15,surge:"moderate",cells:{A:140,B:125},comments:"Surge picked up mid-dive. Stayed shallow.",exitConditions:"Fair"},
      {date:"2023-08-19",divers:9,bottomTime:58,maxDepth:35,waterTemp:57,visibility:25,surge:"light",cells:{B:250,C:260},comments:"Best conditions of season. Large team, great output.",exitConditions:"Excellent"},
      {date:"2023-10-07",divers:6,bottomTime:47,maxDepth:28,waterTemp:54,visibility:18,surge:"moderate",cells:{A:150,B:130},comments:"Juvenile kelp confirmed in A ‚Äî 3 patches ~20cm.",exitConditions:"Good"},
      {date:"2024-01-13",divers:4,bottomTime:45,maxDepth:24,waterTemp:49,visibility:14,surge:"heavy",cells:{A:120,B:70},comments:"Heavy surge, cut dive short. Stayed in shallows.",exitConditions:"Difficult"},
      {date:"2024-03-02",divers:5,bottomTime:50,maxDepth:30,waterTemp:51,visibility:20,surge:"light",cells:{A:110,B:110},comments:"Maintenance pass. Kelp canopy in A now >1m, robust.",exitConditions:"Good"},
      {date:"2024-05-18",divers:5,bottomTime:48,maxDepth:29,waterTemp:54,visibility:22,surge:"light",cells:{A:100,C:105},comments:"Kelp A/B looking strong. Expanded cleaning in C.",exitConditions:"Excellent"},
    ],
    conditions:{sst:54,swell:"2‚Äì3 ft @ 12s",visibility:"18‚Äì22 ft",surge:"Light‚ÄìModerate",wind:"NW 8 kts"},
    cellGrid:{A:{lat:39.358,lng:-123.819},B:{lat:39.357,lng:-123.820},C:{lat:39.356,lng:-123.819},
              D:{lat:39.356,lng:-123.818},E:{lat:39.357,lng:-123.817},F:{lat:39.358,lng:-123.818}},
  },
  albion: {
    id:"albion", name:"Albion Cove", lat:39.227, lng:-123.771, depthRange:"10‚Äì35 ft",
    canopy:[
      {month:"Jan 22",ha:0.3},{month:"Apr 22",ha:0.4},{month:"Jul 22",ha:0.5},{month:"Oct 22",ha:0.55},
      {month:"Jan 23",ha:0.6},{month:"Apr 23",ha:0.9},{month:"Jul 23",ha:1.8},{month:"Oct 23",ha:3.1},
      {month:"Jan 24",ha:4.0},{month:"Apr 24",ha:4.7},{month:"Jun 24",ha:5.0},
    ],
    canopyDied:[{start:"Jan 22",end:"Jan 23",ha:0.4}],
    dives:[
      {date:"2023-03-15",divers:5,bottomTime:50,maxDepth:24,waterTemp:52,visibility:20,surge:"light",cells:{A:160,B:125},comments:"Good conditions. Solid early effort.",exitConditions:"Good"},
      {date:"2023-05-28",divers:7,bottomTime:54,maxDepth:28,waterTemp:55,visibility:22,surge:"light",cells:{A:200,B:170},comments:"Best day yet. Clear water, light surge.",exitConditions:"Excellent"},
      {date:"2023-09-03",divers:6,bottomTime:49,maxDepth:26,waterTemp:56,visibility:19,surge:"moderate",cells:{B:180,C:130},comments:"Pushed into C. Some surge in afternoon.",exitConditions:"Good"},
      {date:"2024-02-17",divers:4,bottomTime:46,maxDepth:22,waterTemp:50,visibility:16,surge:"moderate",cells:{A:100,B:75},comments:"Maintenance only. A looking great.",exitConditions:"Fair"},
      {date:"2024-04-30",divers:5,bottomTime:51,maxDepth:26,waterTemp:53,visibility:21,surge:"light",cells:{A:110,C:105},comments:"Canopy expanding outward from A into B.",exitConditions:"Good"},
    ],
    conditions:{sst:53,swell:"2‚Äì4 ft @ 10s",visibility:"16‚Äì20 ft",surge:"Moderate",wind:"NW 12 kts"},
    cellGrid:{A:{lat:39.228,lng:-123.772},B:{lat:39.227,lng:-123.772},C:{lat:39.226,lng:-123.771},
              D:{lat:39.226,lng:-123.770},E:{lat:39.227,lng:-123.770},F:{lat:39.228,lng:-123.771}},
  },
  ptcabrillo: {
    id:"ptcabrillo", name:"Point Cabrillo", lat:39.348, lng:-123.826, depthRange:"12‚Äì50 ft",
    canopy:[
      {month:"Jan 22",ha:0.5},{month:"Apr 22",ha:0.45},{month:"Jul 22",ha:0.4},{month:"Oct 22",ha:0.35},
      {month:"Jan 23",ha:0.3},{month:"Apr 23",ha:0.4},{month:"Jul 23",ha:0.6},{month:"Oct 23",ha:1.0},
      {month:"Jan 24",ha:1.4},{month:"Apr 24",ha:1.6},{month:"Jun 24",ha:1.5},
    ],
    canopyDied:[{start:"Jan 22",end:"Jan 23",ha:0.5}],
    dives:[
      {date:"2023-04-08",divers:4,bottomTime:48,maxDepth:36,waterTemp:51,visibility:18,surge:"moderate",cells:{A:130,B:100},comments:"Deep site. Urchin density still high in D/E.",exitConditions:"Fair"},
      {date:"2023-07-22",divers:5,bottomTime:52,maxDepth:40,waterTemp:55,visibility:20,surge:"light",cells:{B:160,C:130},comments:"Extended into deeper cells. Good conditions.",exitConditions:"Good"},
      {date:"2023-11-11",divers:3,bottomTime:44,maxDepth:32,waterTemp:52,visibility:14,surge:"moderate",cells:{A:95,B:60},comments:"Small team, limited output. Need bigger crew.",exitConditions:"Fair"},
    ],
    conditions:{sst:52,swell:"3‚Äì5 ft @ 11s",visibility:"12‚Äì18 ft",surge:"Moderate‚ÄìHeavy",wind:"NW 15 kts"},
    cellGrid:{A:{lat:39.349,lng:-123.827},B:{lat:39.348,lng:-123.827},C:{lat:39.347,lng:-123.826},
              D:{lat:39.347,lng:-123.825},E:{lat:39.348,lng:-123.825},F:{lat:39.349,lng:-123.826}},
  },
  russian: {
    id:"russian", name:"Russian Gulch", lat:39.329, lng:-123.802, depthRange:"6‚Äì38 ft",
    canopy:[
      {month:"Jan 22",ha:1.2},{month:"Apr 22",ha:1.0},{month:"Jul 22",ha:0.9},{month:"Oct 22",ha:0.8},
      {month:"Jan 23",ha:0.8},{month:"Apr 23",ha:0.6},{month:"Jul 23",ha:0.4},{month:"Oct 23",ha:0.3},
      {month:"Jan 24",ha:0.2},{month:"Apr 24",ha:0.2},{month:"Jun 24",ha:0.1},
    ],
    canopyDied:[{start:"Jan 22",end:"Jun 24",ha:1.1}],
    dives:[
      {date:"2023-05-14",divers:3,bottomTime:42,maxDepth:22,waterTemp:52,visibility:12,surge:"heavy",cells:{A:100,B:80},comments:"Heavy surge, limited safe work. Site declining fast.",exitConditions:"Difficult"},
    ],
    conditions:{sst:52,swell:"4‚Äì6 ft @ 10s",visibility:"10‚Äì14 ft",surge:"Heavy",wind:"NW 18 kts"},
    cellGrid:{A:{lat:39.330,lng:-123.803},B:{lat:39.329,lng:-123.803},C:{lat:39.328,lng:-123.802},
              D:{lat:39.328,lng:-123.801},E:{lat:39.329,lng:-123.801},F:{lat:39.330,lng:-123.802}},
  },
  noyo: {
    id:"noyo", name:"Noyo Harbor Approach", lat:39.427, lng:-123.802, depthRange:"14‚Äì55 ft",
    canopy:[
      {month:"Jan 22",ha:1.3},{month:"Apr 22",ha:1.2},{month:"Jul 22",ha:1.15},{month:"Oct 22",ha:1.1},
      {month:"Jan 23",ha:1.1},{month:"Apr 23",ha:1.0},{month:"Jul 23",ha:0.9},{month:"Oct 23",ha:0.8},
      {month:"Jan 24",ha:0.7},{month:"Apr 24",ha:0.7},{month:"Jun 24",ha:0.6},
    ],
    canopyDied:[{start:"Jan 22",end:"Jun 24",ha:0.7}],
    dives:[],
    conditions:{sst:51,swell:"3‚Äì5 ft @ 12s",visibility:"10‚Äì15 ft",surge:"Moderate",wind:"NW 14 kts"},
    cellGrid:{A:{lat:39.428,lng:-123.803},B:{lat:39.427,lng:-123.803},C:{lat:39.426,lng:-123.802},
              D:{lat:39.426,lng:-123.801},E:{lat:39.427,lng:-123.801},F:{lat:39.428,lng:-123.802}},
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDaysSince(dateStr){
  return Math.floor((new Date("2024-06-25")-new Date(dateStr))/86400000);
}
function getRecentDives(site,days=90){
  const cut=new Date("2024-06-25")-days*86400000;
  return site.dives.filter(d=>new Date(d.date)>=cut);
}
function getSiteEfficiency(site){
  const hrs=site.dives.reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0);
  const gain=site.canopy[site.canopy.length-1].ha-site.canopy[0].ha;
  return hrs>0&&gain>0?(hrs/gain).toFixed(1):null;
}
function getTotalUrchinsByCell(site){
  const totals={};
  CELLS.forEach(c=>{totals[c]=0;});
  site.dives.forEach(d=>Object.entries(d.cells||{}).forEach(([c,n])=>{totals[c]=(totals[c]||0)+n;}));
  return totals;
}
function getProgramTotals(){
  const all=Object.values(SITES);
  return {
    hrs:Math.round(all.flatMap(s=>s.dives).reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0)),
    urchins:all.flatMap(s=>s.dives).reduce((s,d)=>s+Object.values(d.cells||{}).reduce((a,b)=>a+b,0),0),
    ha:all.reduce((s,site)=>s+Math.max(0,site.canopy[site.canopy.length-1].ha-site.canopy[0].ha),0).toFixed(1),
    dives:all.flatMap(s=>s.dives).length,
  };
}
function getDiveSuitability(site){
  const c=site.conditions;
  const swellFt=parseFloat(c.swell);
  let score=100;
  if(swellFt>=5)score-=40; else if(swellFt>=3)score-=20;
  if(c.surge==="Heavy")score-=35; else if(c.surge==="Moderate‚ÄìHeavy")score-=20; else if(c.surge==="Moderate")score-=10;
  const vis=parseInt(c.visibility);
  if(vis<12)score-=20; else if(vis<16)score-=8;
  if(c.sst<50)score-=15; else if(c.sst<52)score-=5;
  score=Math.max(0,Math.min(100,score));
  const label=score>=75?"Excellent":score>=55?"Good":score>=35?"Marginal":"Poor";
  const color=score>=75?"#16a34a":score>=55?"#0e7490":score>=35?"#d97706":"#dc2626";
  return{score,label,color};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SVG MAP (shared across pages)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAP_W=480,MAP_H=360;
const BOUNDS={latMin:39.10,latMax:39.55,lngMin:-124.02,lngMax:-123.52};
function proj(lat,lng){
  return[
    parseFloat(((lng-BOUNDS.lngMin)/(BOUNDS.lngMax-BOUNDS.lngMin)*MAP_W).toFixed(2)),
    parseFloat((MAP_H-((lat-BOUNDS.latMin)/(BOUNDS.latMax-BOUNDS.latMin)*MAP_H)).toFixed(2))
  ];
}
const COAST=[
  [39.550,-123.690],[39.530,-123.710],[39.510,-123.730],[39.490,-123.755],
  [39.470,-123.768],[39.450,-123.780],[39.427,-123.802],[39.410,-123.815],
  [39.395,-123.822],[39.370,-123.826],[39.357,-123.818],[39.348,-123.826],
  [39.340,-123.818],[39.329,-123.802],[39.315,-123.798],[39.300,-123.797],
  [39.280,-123.787],[39.260,-123.782],[39.245,-123.775],[39.227,-123.771],
  [39.210,-123.762],[39.190,-123.750],[39.170,-123.738],[39.150,-123.726],
  [39.130,-123.714],[39.110,-123.700],
];

function SiteMap({selectedId,onSelect,highlightDot,compact=false}){
  const [hov,setHov]=useState(null);
  const sites=Object.values(SITES);
  const W=compact?380:MAP_W, H=compact?280:MAP_H;
  const scale=compact?W/MAP_W:1;

  function p(lat,lng){
    const[x,y]=proj(lat,lng);
    return[x*scale,y*(H/MAP_H)];
  }

  const coastPts=COAST.map(([lat,lng])=>p(lat,lng).join(",")).join(" ");
  const landPoly=COAST.map(([lat,lng])=>p(lat,lng).join(",")).join(" ")+` ${W},${H} ${W},0`;
  const shallow=COAST.map(([lat,lng])=>{const[x,y]=p(lat,lng-0.025);return`${x},${y}`;}).join(" ");

  return(
    <svg viewBox={`0 0 ${W} ${H}`} width="100%" height="100%" style={{display:"block"}}>
      <defs>
        <linearGradient id="og" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stopColor="#c8e6f4"/><stop offset="100%" stopColor="#a4cfe8"/>
        </linearGradient>
        <linearGradient id="lg" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stopColor="#e4ece0"/><stop offset="100%" stopColor="#cdd8c5"/>
        </linearGradient>
        <linearGradient id="sf" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%" stopColor="#afd9f0" stopOpacity="0.65"/>
          <stop offset="100%" stopColor="#a4cfe8" stopOpacity="0"/>
        </linearGradient>
        <pattern id="wg" x="0" y="0" width="26" height="26" patternUnits="userSpaceOnUse">
          <path d="M0,13 Q6.5,9 13,13 Q19.5,17 26,13" stroke="#86c4e0" strokeWidth="0.35" fill="none" opacity="0.5"/>
        </pattern>
        <filter id="gl"><feGaussianBlur in="SourceGraphic" stdDeviation="5" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <clipPath id="cc"><rect width={W} height={H}/></clipPath>
      </defs>
      <g clipPath="url(#cc)">
        <rect width={W} height={H} fill="url(#og)"/>
        <rect width={W} height={H} fill="url(#wg)"/>
        <polyline points={shallow+" "+[...COAST].reverse().map(([la,ln])=>p(la,ln).join(",")).join(" ")} fill="url(#sf)" stroke="none"/>
        {[0.018,0.034].map((off,i)=>(
          <polyline key={i} points={COAST.map(([la,ln])=>p(la,ln-off).join(",")).join(" ")}
            fill="none" stroke="#5ab0d8" strokeWidth={0.45} strokeDasharray="4,7" opacity={0.35}/>
        ))}
        <polygon points={landPoly} fill="url(#lg)"/>
        <polyline points={coastPts} fill="none" stroke="#7a9a72" strokeWidth={1.6} strokeLinejoin="round"/>
        {[39.2,39.3,39.4,39.5].map(lat=>{
          const[,y]=p(lat,-124.02);
          return<text key={lat} x={4} y={y+4} fontSize={7.5} fill="#4a9ab8" opacity={0.7} fontFamily="monospace">{lat.toFixed(1)}¬∞N</text>;
        })}
        <text x={60} y={H*0.55} fontSize={11} fill="#4488a8" opacity={0.5} fontStyle="italic" fontFamily="Georgia,serif"
          transform={`rotate(-10,60,${H*0.55})`}>Pacific Ocean</text>
        <g transform={`translate(${W-28},24)`}>
          <circle r={13} fill="white" opacity={0.85} stroke="#c8d4c0" strokeWidth={1}/>
          <text y={-14} textAnchor="middle" fontSize={8} fill="#0a2342" fontWeight="700">N</text>
          <polygon points="0,-10 -3,0 0,3 3,0" fill="#0a2342" opacity={0.7}/>
          <polygon points="0,10 -3,0 0,-3 3,0" fill="#94a3b8" opacity={0.5}/>
        </g>
        {sites.map(site=>{
          const[mx,my]=p(site.lat,site.lng);
          const isSel=selectedId===site.id;
          const isHov=hov===site.id;
          const dot=highlightDot?.(site)||"#0e7490";
          const r=isSel?12:9;
          const show=isSel||isHov;
          const lw=site.name.length*5.4+12;
          return(
            <g key={site.id} style={{cursor:"pointer"}}
              onClick={()=>onSelect?.(site.id)}
              onMouseEnter={()=>setHov(site.id)}
              onMouseLeave={()=>setHov(null)}>
              {isSel&&<circle cx={mx} cy={my} r={r+8} fill={dot} opacity={0.18} filter="url(#gl)"/>}
              {isSel&&<circle cx={mx} cy={my} r={r+5} fill="none" stroke={dot} strokeWidth={1.5} opacity={0.35}/>}
              <circle cx={mx} cy={my} r={r} fill={dot} stroke={isSel?"#0a2342":"white"} strokeWidth={isSel?2.5:1.8} opacity={0.92}/>
              <circle cx={mx-r*0.25} cy={my-r*0.25} r={r*0.3} fill="white" opacity={0.28}/>
              {show&&(
                <g>
                  <rect x={mx+r+4} y={my-12} width={lw} height={16} rx={4} fill="#0a2342" opacity={0.88}/>
                  <text x={mx+r+10} y={my+1} fontSize={9} fill="white" fontWeight="600" fontFamily="'DM Sans',sans-serif">{site.name}</text>
                </g>
              )}
            </g>
          );
        })}
      </g>
    </svg>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 1 ‚Äî SITE STATUS + DIVE PLANNING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Page1({selectedSite,setSelectedSite}){
  const site=SITES[selectedSite];
  const recent=getRecentDives(site,90);
  const suitability=getDiveSuitability(site);
  const lastDive=site.dives[site.dives.length-1];
  const canopyNow=site.canopy[site.canopy.length-1].ha;
  const canopyPrev=site.canopy[site.canopy.length-2].ha;
  const trend=canopyNow>canopyPrev+0.05?"‚Üë":canopyNow<canopyPrev-0.05?"‚Üì":"‚Üí";
  const trendClr=trend==="‚Üë"?"#16a34a":trend==="‚Üì"?"#dc2626":"#64748b";

  const recentComments=site.dives.slice(-3).reverse().map(d=>({date:d.date,text:d.comments,exit:d.exitConditions}));

  const exitColors={Excellent:"#16a34a",Good:"#0e7490",Fair:"#d97706",Difficult:"#dc2626"};

  const S={
    card:{background:"#fff",borderRadius:12,padding:"14px 16px",border:"1px solid #e2e8f0"},
    label:{fontSize:10,fontWeight:700,color:"#94a3b8",textTransform:"uppercase",letterSpacing:"0.07em",display:"block",marginBottom:4},
    big:{fontSize:22,fontWeight:800,color:"#0a2342",lineHeight:1},
  };

  return(
    <div style={{display:"flex",height:"100%",minHeight:0}}>
      {/* LEFT: Map */}
      <div style={{width:"52%",background:"#c8e6f4",borderRight:"1px solid #e2e8f0",position:"relative",overflow:"hidden"}}>
        <SiteMap selectedId={selectedSite} onSelect={setSelectedSite}
          highlightDot={s=>getDiveSuitability(s).color}/>
        {/* Suitability legend */}
        <div style={{position:"absolute",bottom:12,left:12,background:"rgba(255,255,255,0.95)",
          borderRadius:8,padding:"8px 12px",border:"1px solid #e2e8f0",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"}}>
          <div style={{fontSize:9,fontWeight:700,color:"#94a3b8",textTransform:"uppercase",letterSpacing:"0.07em",marginBottom:6}}>Dive Suitability</div>
          {[["#16a34a","Excellent"],["#0e7490","Good"],["#d97706","Marginal"],["#dc2626","Poor"]].map(([c,l])=>(
            <div key={l} style={{display:"flex",alignItems:"center",gap:6,marginBottom:4,fontSize:10}}>
              <span style={{width:8,height:8,borderRadius:"50%",background:c,display:"inline-block",flexShrink:0}}/>
              <span style={{color:"#475569",fontWeight:500}}>{l}</span>
            </div>
          ))}
          <div style={{marginTop:6,paddingTop:6,borderTop:"1px solid #f1f5f9",fontSize:9,color:"#94a3b8"}}>Click site to view details</div>
        </div>
      </div>

      {/* RIGHT: Detail */}
      <div style={{width:"48%",overflowY:"auto",padding:"16px",display:"flex",flexDirection:"column",gap:12,background:"#f8fafc"}}>

        {/* Site name + breadcrumb */}
        <div>
          <div style={{fontSize:11,color:"#94a3b8",marginBottom:2}}>
            {Object.values(SITES).map((s,i)=>(
              <span key={s.id}>
                {i>0&&<span style={{margin:"0 4px",opacity:0.4}}>¬∑</span>}
                <span onClick={()=>setSelectedSite(s.id)}
                  style={{cursor:"pointer",color:s.id===selectedSite?"#0a2342":"#94a3b8",
                    fontWeight:s.id===selectedSite?700:400,textDecoration:"underline",textDecorationColor:"transparent",
                    borderBottom:s.id===selectedSite?"2px solid #0e7490":"none"}}>
                  {s.name.split(" ")[0]}
                </span>
              </span>
            ))}
          </div>
          <h2 style={{margin:"4px 0 2px",fontSize:20,fontWeight:700,color:"#0a2342",fontFamily:"'Fraunces',Georgia,serif",letterSpacing:"-0.02em"}}>
            {site.name}
          </h2>
          <div style={{fontSize:12,color:"#64748b"}}>Mendocino County ¬∑ {site.depthRange}</div>
        </div>

        {/* Conditions strip */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:8}}>
          {[
            {label:"Canopy",val:`${canopyNow} ha`,sub:trend,subClr:trendClr,subBig:true},
            {label:"Water Temp",val:`${site.conditions.sst}¬∞F`,sub:"surface"},
            {label:"Swell",val:site.conditions.swell.split("@")[0].trim(),sub:`@ ${site.conditions.swell.split("@")[1]?.trim()||""}`},
            {label:"Visibility",val:site.conditions.visibility.split("‚Äì")[0].trim(),sub:"ft range"},
          ].map(item=>(
            <div key={item.label} style={S.card}>
              <span style={S.label}>{item.label}</span>
              <div style={{...S.big,fontSize:16}}>{item.val}</div>
              <div style={{fontSize:11,color:item.subClr||"#94a3b8",fontWeight:item.subBig?700:400,marginTop:2}}>{item.sub}</div>
            </div>
          ))}
        </div>

        {/* Dive suitability bar */}
        <div style={{...S.card,padding:"12px 16px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
            <span style={S.label}>Dive Suitability Today</span>
            <span style={{fontSize:13,fontWeight:700,color:suitability.color}}>{suitability.label} ({suitability.score}/100)</span>
          </div>
          <div style={{height:8,background:"#f1f5f9",borderRadius:4,overflow:"hidden"}}>
            <div style={{height:"100%",width:`${suitability.score}%`,background:suitability.color,borderRadius:4,transition:"width 0.8s ease"}}/>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"4px 16px",marginTop:10}}>
            {[["Surge",site.conditions.surge],["Wind",site.conditions.wind],
              ["Visibility",site.conditions.visibility],["Swell",site.conditions.swell]].map(([l,v])=>(
              <div key={l} style={{fontSize:11,display:"flex",justifyContent:"space-between"}}>
                <span style={{color:"#94a3b8"}}>{l}</span>
                <span style={{color:"#334155",fontWeight:500}}>{v}</span>
              </div>
            ))}
          </div>
        </div>

        {/* Recent activity */}
        <div style={S.card}>
          <span style={S.label}>90-Day Activity Summary</span>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:12}}>
            {[
              {l:"Dives",v:recent.length},
              {l:"Diver-Hrs",v:recent.reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0).toFixed(1)},
              {l:"Urchins Culled",v:recent.reduce((s,d)=>s+Object.values(d.cells||{}).reduce((a,b)=>a+b,0),0).toLocaleString()},
            ].map(item=>(
              <div key={item.l} style={{textAlign:"center",padding:"8px 6px",background:"#f8fafc",borderRadius:8,border:"1px solid #e2e8f0"}}>
                <div style={{fontSize:20,fontWeight:800,color:"#0a2342",lineHeight:1}}>{item.v}</div>
                <div style={{fontSize:9,color:"#94a3b8",fontWeight:600,marginTop:3,textTransform:"uppercase",letterSpacing:"0.06em"}}>{item.l}</div>
              </div>
            ))}
          </div>
          {lastDive&&(
            <div style={{fontSize:11,color:"#64748b"}}>
              Last dive: <span style={{color:"#0a2342",fontWeight:600}}>{lastDive.date}</span>
              {" "}¬∑ {getDaysSince(lastDive.date)} days ago ¬∑ {lastDive.divers} divers
            </div>
          )}
        </div>

        {/* Exit form comments */}
        <div style={S.card}>
          <span style={S.label}>Recent Exit Form Comments</span>
          {recentComments.map((c,i)=>(
            <div key={i} style={{padding:"8px 10px",borderRadius:8,background:"#f8fafc",marginBottom:6,
              border:"1px solid #e2e8f0"}}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                <span style={{fontSize:10,color:"#94a3b8",fontFamily:"monospace"}}>{c.date}</span>
                <span style={{fontSize:10,fontWeight:600,padding:"1px 7px",borderRadius:10,
                  background:`${exitColors[c.exit]}18`,color:exitColors[c.exit],
                  border:`1px solid ${exitColors[c.exit]}44`}}>{c.exit}</span>
              </div>
              <div style={{fontSize:12,color:"#334155",lineHeight:1.5}}>{c.text}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 2 ‚Äî DIVE INPUT / EXIT FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Page2({selectedSite,setSelectedSite}){
  const [form,setForm]=useState({
    site:selectedSite,name:"",email:"",groupSize:"",
    date:"",maxDepth:"",bottomTime:"",waterTemp:"",
    visibility:"",surge:"moderate",
    cells:{A:"",B:"",C:"",D:"",E:"",F:""},
    comments:"",exitConditions:"Good",
    importSource:null,
  });
  const [submitted,setSubmitted]=useState(false);
  const [importing,setImporting]=useState(false);
  const fileRef=useRef();

  const set=(k,v)=>setForm(f=>({...f,[k]:v}));
  const setCell=(c,v)=>setForm(f=>({...f,cells:{...f.cells,[c]:v}}));

  // Simulate watch/PADI import filling dive metadata
  function simulateWatchImport(source){
    setImporting(true);
    setTimeout(()=>{
      setForm(f=>({...f,
        date:"2024-06-25",maxDepth:"31",bottomTime:"52",waterTemp:"54",
        importSource:source,
      }));
      setImporting(false);
    },1200);
  }

  const inputSty={
    width:"100%",background:"#fff",border:"1px solid #e2e8f0",borderRadius:8,
    padding:"8px 12px",fontSize:13,color:"#0a2342",outline:"none",fontFamily:"inherit",
  };
  const labelSty={fontSize:10,fontWeight:700,color:"#64748b",textTransform:"uppercase",letterSpacing:"0.07em",display:"block",marginBottom:4};
  const row={display:"flex",flexDirection:"column"};

  if(submitted){
    const total=Object.values(form.cells).reduce((s,v)=>s+(parseInt(v)||0),0);
    return(
      <div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",flexDirection:"column",gap:16,padding:40}}>
        <div style={{fontSize:48}}>üåø</div>
        <div style={{fontSize:22,fontWeight:700,color:"#0a2342",fontFamily:"'Fraunces',Georgia,serif"}}>Dive logged!</div>
        <div style={{fontSize:14,color:"#64748b",textAlign:"center",maxWidth:360}}>
          <strong style={{color:"#0a2342"}}>{total.toLocaleString()}</strong> urchins removed at <strong style={{color:"#0a2342"}}>{SITES[form.site]?.name}</strong> on {form.date}.
          Exit conditions: <strong style={{color:"#0a2342"}}>{form.exitConditions}</strong>.
        </div>
        <button onClick={()=>{setSubmitted(false);setForm(f=>({...f,cells:{A:"",B:"",C:"",D:"",E:"",F:""},comments:"",name:"",email:"",groupSize:""}));}}
          style={{padding:"10px 28px",borderRadius:8,background:"#0a2342",color:"white",border:"none",cursor:"pointer",fontSize:14,fontWeight:600}}>
          Log Another Dive
        </button>
      </div>
    );
  }

  return(
    <div style={{display:"flex",height:"100%",minHeight:0}}>
      {/* LEFT: site selector context */}
      <div style={{width:"30%",background:"#f0f4f8",borderRight:"1px solid #e2e8f0",padding:"20px 16px",overflowY:"auto"}}>
        <div style={{fontSize:11,fontWeight:700,color:"#64748b",textTransform:"uppercase",letterSpacing:"0.07em",marginBottom:12}}>Select Site</div>
        {Object.values(SITES).map(s=>(
          <div key={s.id} onClick={()=>{setSelectedSite(s.id);set("site",s.id);}}
            style={{padding:"10px 12px",borderRadius:10,cursor:"pointer",marginBottom:8,
              background:form.site===s.id?"#0a2342":"white",
              border:`1px solid ${form.site===s.id?"#0a2342":"#e2e8f0"}`,
              color:form.site===s.id?"white":"#0a2342"}}>
            <div style={{fontWeight:600,fontSize:13}}>{s.name}</div>
            <div style={{fontSize:11,opacity:0.6,marginTop:2}}>{s.depthRange}</div>
          </div>
        ))}

        <div style={{marginTop:20,padding:"14px",background:"white",borderRadius:10,border:"1px solid #e2e8f0"}}>
          <div style={{fontSize:11,fontWeight:700,color:"#64748b",textTransform:"uppercase",letterSpacing:"0.07em",marginBottom:10}}>
            Import Dive Data
          </div>
          <div style={{fontSize:11,color:"#64748b",marginBottom:10,lineHeight:1.5}}>
            Auto-fill dive metadata from your dive computer or log.
          </div>
          {form.importSource&&(
            <div style={{padding:"6px 10px",background:"#f0fdf4",borderRadius:6,border:"1px solid #86efac",
              fontSize:11,color:"#14532d",marginBottom:8}}>
              ‚úì Imported from {form.importSource}
            </div>
          )}
          <div style={{display:"flex",flexDirection:"column",gap:6}}>
            {[["ü§ø Garmin / Suunto Watch","Garmin/Suunto"],["üì± PADI Dive Log","PADI"],["üìÅ UDDF File","UDDF file"]].map(([label,src])=>(
              <button key={src} onClick={()=>simulateWatchImport(src)} disabled={importing}
                style={{padding:"8px 10px",borderRadius:7,border:"1px solid #e2e8f0",background:importing?"#f8fafc":"white",
                  cursor:importing?"not-allowed":"pointer",fontSize:11,fontWeight:500,
                  color:importing?"#94a3b8":"#0a2342",textAlign:"left"}}>
                {importing?`‚è≥ Importing‚Ä¶`:label}
              </button>
            ))}
            <button onClick={()=>fileRef.current?.click()}
              style={{padding:"8px 10px",borderRadius:7,border:"1px dashed #cbd5e1",background:"#f8fafc",
                cursor:"pointer",fontSize:11,fontWeight:500,color:"#64748b",textAlign:"left"}}>
              üìé Upload UDDF / CSV file
            </button>
            <input ref={fileRef} type="file" accept=".uddf,.csv,.xml" style={{display:"none"}}
              onChange={()=>simulateWatchImport("uploaded file")}/>
          </div>
          <div style={{marginTop:10,fontSize:9,color:"#94a3b8",lineHeight:1.5}}>
            Supported: UDDF (Universal Dive Data Format), Garmin FIT, Suunto DM, PADI app export, CSV
          </div>
        </div>
      </div>

      {/* RIGHT: Form */}
      <div style={{flex:1,overflowY:"auto",padding:"20px 24px",background:"#fff"}}>
        <h2 style={{margin:"0 0 4px",fontSize:18,fontWeight:700,color:"#0a2342",fontFamily:"'Fraunces',Georgia,serif"}}>
          Post-Dive Exit Form
        </h2>
        <p style={{margin:"0 0 20px",fontSize:12,color:"#64748b"}}>
          {SITES[form.site]?.name} ¬∑ Complete after each cull dive
        </p>

        {/* Diver info */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12,marginBottom:20}}>
          <div style={row}><label style={labelSty}>Diver Name *</label>
            <input style={inputSty} value={form.name} onChange={e=>set("name",e.target.value)} placeholder="Full name"/></div>
          <div style={row}><label style={labelSty}>Email</label>
            <input style={inputSty} value={form.email} onChange={e=>set("email",e.target.value)} placeholder="you@example.com"/></div>
          <div style={row}><label style={labelSty}>Divers in Group *</label>
            <input style={{...inputSty}} type="number" min="1" value={form.groupSize} onChange={e=>set("groupSize",e.target.value)} placeholder="e.g. 4"/></div>
        </div>

        {/* Dive metadata ‚Äî auto-filled by watch import */}
        <div style={{background:"#f8fafc",borderRadius:10,padding:"14px 16px",border:"1px solid #e2e8f0",marginBottom:20}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <span style={{fontSize:12,fontWeight:700,color:"#0a2342"}}>Dive Metadata</span>
            {form.importSource?(
              <span style={{fontSize:10,padding:"2px 8px",borderRadius:10,background:"#f0fdf4",
                color:"#14532d",border:"1px solid #86efac"}}>‚úì Auto-filled ¬∑ {form.importSource}</span>
            ):(
              <span style={{fontSize:10,color:"#94a3b8"}}>Auto-filled by watch import ‚Üë</span>
            )}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:12}}>
            {[
              {k:"date",label:"Date *",type:"date",ph:""},
              {k:"maxDepth",label:"Max Depth (ft)",type:"number",ph:"e.g. 32"},
              {k:"bottomTime",label:"Bottom Time (min)",type:"number",ph:"e.g. 48"},
              {k:"waterTemp",label:"Water Temp (¬∞F)",type:"number",ph:"e.g. 53"},
            ].map(f=>(
              <div key={f.k} style={row}>
                <label style={labelSty}>{f.label}</label>
                <input style={{...inputSty,background:form.importSource&&form[f.k]?"#f0fdf4":"white",
                  borderColor:form.importSource&&form[f.k]?"#86efac":"#e2e8f0"}}
                  type={f.type} value={form[f.k]} onChange={e=>set(f.k,e.target.value)} placeholder={f.ph}/>
              </div>
            ))}
          </div>
        </div>

        {/* Dive conditions */}
        <div style={{marginBottom:20}}>
          <div style={{fontSize:12,fontWeight:700,color:"#0a2342",marginBottom:10}}>Dive Conditions</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            <div style={row}><label style={labelSty}>Visibility (ft)</label>
              <input style={inputSty} type="number" value={form.visibility} onChange={e=>set("visibility",e.target.value)} placeholder="e.g. 18"/></div>
            <div style={row}><label style={labelSty}>Surge</label>
              <select style={inputSty} value={form.surge} onChange={e=>set("surge",e.target.value)}>
                {["light","moderate","moderate-heavy","heavy"].map(o=>(
                  <option key={o} value={o}>{o.charAt(0).toUpperCase()+o.slice(1)}</option>
                ))}
              </select></div>
          </div>
        </div>

        {/* Cell urchin counts */}
        <div style={{marginBottom:20}}>
          <div style={{fontSize:12,fontWeight:700,color:"#0a2342",marginBottom:4}}>Urchins Culled by Cell *</div>
          <div style={{fontSize:11,color:"#94a3b8",marginBottom:10}}>Enter count for each cell worked. Leave blank if cell not dived.</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(6,1fr)",gap:8}}>
            {CELLS.map(c=>(
              <div key={c} style={{textAlign:"center"}}>
                <div style={{fontSize:11,fontWeight:700,color:"#0a2342",marginBottom:4}}>Cell {c}</div>
                <input style={{...inputSty,textAlign:"center",padding:"8px 4px"}}
                  type="number" min="0" value={form.cells[c]} onChange={e=>setCell(c,e.target.value)}
                  placeholder="0"/>
              </div>
            ))}
          </div>
          <div style={{marginTop:8,fontSize:12,color:"#0e7490",fontWeight:600}}>
            Total: {Object.values(form.cells).reduce((s,v)=>s+(parseInt(v)||0),0).toLocaleString()} urchins
          </div>
        </div>

        {/* Exit conditions */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:20}}>
          <div style={row}><label style={labelSty}>Exit Conditions</label>
            <select style={inputSty} value={form.exitConditions} onChange={e=>set("exitConditions",e.target.value)}>
              {["Excellent","Good","Fair","Difficult"].map(o=><option key={o} value={o}>{o}</option>)}
            </select></div>
          <div/></div>

        {/* Comments */}
        <div style={{...row,marginBottom:24}}>
          <label style={labelSty}>Comments / Observations</label>
          <textarea style={{...inputSty,resize:"vertical"}} rows={3}
            value={form.comments} onChange={e=>set("comments",e.target.value)}
            placeholder="Kelp recruits observed, unusual species, GPS coords, dive conditions narrative‚Ä¶"/>
        </div>

        <button onClick={()=>setSubmitted(true)}
          style={{padding:"12px 32px",borderRadius:10,background:"#0a2342",color:"white",border:"none",
            cursor:"pointer",fontSize:15,fontWeight:700,letterSpacing:"-0.01em"}}>
          Submit Dive Log ‚Üí
        </button>
      </div>
    </div>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 3 ‚Äî IMPACT SUMMARIES + LONG-TERM EVALUATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function CellGridMap({site}){
  const cells=site.cellGrid;
  const totals=getTotalUrchinsByCell(site);
  const maxU=Math.max(...Object.values(totals),1);
  const W=260,H=200;
  const lats=Object.values(cells).map(c=>c.lat);
  const lngs=Object.values(cells).map(c=>c.lng);
  const latMin=Math.min(...lats)-0.0015,latMax=Math.max(...lats)+0.0015;
  const lngMin=Math.min(...lngs)-0.002,lngMax=Math.max(...lngs)+0.002;
  function cp(lat,lng){
    return[
      ((lng-lngMin)/(lngMax-lngMin)*W).toFixed(1),
      (H-((lat-latMin)/(latMax-latMin)*H)).toFixed(1)
    ];
  }
  return(
    <svg viewBox={`0 0 ${W} ${H}`} width="100%" height={H}>
      <rect width={W} height={H} fill="#c8e6f4" rx={8}/>
      {CELLS.map(c=>{
        const pos=cells[c];
        if(!pos)return null;
        const[cx,cy]=cp(pos.lat,pos.lng);
        const intensity=totals[c]/maxU;
        const fill=`rgba(14,116,144,${0.1+intensity*0.85})`;
        const sz=22+intensity*14;
        return(
          <g key={c}>
            <rect x={parseFloat(cx)-sz/2} y={parseFloat(cy)-sz/2} width={sz} height={sz}
              rx={4} fill={fill} stroke="white" strokeWidth={1.5}/>
            <text x={cx} y={parseFloat(cy)+4} textAnchor="middle" fontSize={10} fill="white" fontWeight="700">{c}</text>
            {totals[c]>0&&(
              <text x={cx} y={parseFloat(cy)+sz/2+12} textAnchor="middle" fontSize={7.5} fill="#0e7490" fontWeight="600">
                {totals[c].toLocaleString()}
              </text>
            )}
          </g>
        );
      })}
      <text x={W/2} y={H-4} textAnchor="middle" fontSize={8} fill="#4488a8" opacity={0.7}>Cell size ‚àù urchins removed</text>
    </svg>
  );
}

// Timeseries replay map
function ReplayMap({site,replayIdx}){
  const snap=site.canopy[Math.min(replayIdx,site.canopy.length-1)];
  const prev=site.canopy[0];
  const intensity=Math.min(1,(snap.ha-prev.ha)/6);
  const died=site.canopyDied||[];
  const W=260,H=190;
  const[mx,my]=proj(site.lat,site.lng);
  const scaleX=W/MAP_W,scaleY=H/MAP_H;
  const sx=mx*scaleX,sy=my*scaleY;
  return(
    <svg viewBox={`0 0 ${W} ${H}`} width="100%" height={H}>
      <rect width={W} height={H} fill="#c8e6f4" rx={8}/>
      {/* Died area (gray) */}
      {died.length>0&&(
        <circle cx={sx} cy={sy} r={25} fill="#94a3b8" opacity={0.35}/>
      )}
      {/* Live canopy circle */}
      <circle cx={sx} cy={sy} r={8+intensity*32}
        fill={`rgba(22,163,74,${0.15+intensity*0.5})`} stroke="#16a34a" strokeWidth={1.5}/>
      <circle cx={sx} cy={sy} r={6} fill="#16a34a" opacity={0.9}/>
      <text x={sx} y={sy+28+intensity*20} textAnchor="middle" fontSize={9} fill="#16a34a" fontWeight="700">
        {snap.ha} ha
      </text>
      <text x={sx} y={sy-18} textAnchor="middle" fontSize={9} fill="#0a2342" fontWeight="600">
        {snap.month}
      </text>
      {died.length>0&&(
        <text x={sx+30} y={sy} textAnchor="start" fontSize={7.5} fill="#64748b">
          Lost area ‚Üó
        </text>
      )}
      <text x={W/2} y={H-5} textAnchor="middle" fontSize={7.5} fill="#4488a8" opacity={0.7}>{site.name}</text>
    </svg>
  );
}

function Page3({selectedSite,setSelectedSite}){
  const site=SITES[selectedSite];
  const [replayIdx,setReplayIdx]=useState(site.canopy.length-1);
  const [playing,setPlaying]=useState(false);
  const playRef=useRef(null);
  const cellTotals=getTotalUrchinsByCell(site);
  const eff=getSiteEfficiency(site);
  const allSites=Object.values(SITES);

  // Auto-advance replay
  const togglePlay=()=>{
    if(playing){clearInterval(playRef.current);setPlaying(false);}
    else{
      setReplayIdx(0);
      setPlaying(true);
      let i=0;
      playRef.current=setInterval(()=>{
        i++;
        if(i>=site.canopy.length){clearInterval(playRef.current);setPlaying(false);return;}
        setReplayIdx(i);
      },700);
    }
  };

  // Cumulative urchin bars
  const cumulData=[];
  let cum=0;
  site.dives.forEach(d=>{
    const n=Object.values(d.cells||{}).reduce((a,b)=>a+b,0);
    cum+=n;
    cumulData.push({date:d.date.slice(0,7),urchins:n,cumulative:cum,diverHours:parseFloat((d.divers*d.bottomTime/60).toFixed(1))});
  });

  // All-sites comparison
  const siteComp=allSites.map(s=>({
    name:s.name.split(" ")[0],
    ha:s.canopy[s.canopy.length-1].ha,
    gain:parseFloat((s.canopy[s.canopy.length-1].ha-s.canopy[0].ha).toFixed(2)),
    dives:s.dives.length,
    hrs:parseFloat(s.dives.reduce((sum,d)=>sum+(d.divers*d.bottomTime)/60,0).toFixed(1)),
  }));

  function exportCSV(){
    const rows=[["Date","Divers","Bottom Time","Max Depth","Water Temp","Visibility","Surge",
      ...CELLS.map(c=>`Cell ${c} Urchins`),"Total Urchins","Comments","Exit Conditions"]];
    site.dives.forEach(d=>{
      const total=Object.values(d.cells||{}).reduce((a,b)=>a+b,0);
      rows.push([d.date,d.divers,d.bottomTime,d.maxDepth,d.waterTemp,d.visibility,d.surge,
        ...CELLS.map(c=>d.cells?.[c]||0),total,`"${d.comments}"`,d.exitConditions]);
    });
    const csv=rows.map(r=>r.join(",")).join("\n");
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download=`${site.id}_dive_data.csv`;a.click();
  }

  const S={
    card:{background:"#fff",borderRadius:12,padding:"14px 16px",border:"1px solid #e2e8f0"},
    label:{fontSize:10,fontWeight:700,color:"#94a3b8",textTransform:"uppercase",letterSpacing:"0.07em",display:"block",marginBottom:6},
  };

  const ttStyle={background:"#0a2342",border:"none",borderRadius:6,fontSize:11,color:"#fff",padding:"4px 10px"};

  return(
    <div style={{overflowY:"auto",padding:"20px",background:"#f8fafc",height:"100%",display:"flex",flexDirection:"column",gap:16}}>

      {/* Site selector tabs */}
      <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
        {allSites.map(s=>(
          <button key={s.id} onClick={()=>{setSelectedSite(s.id);setReplayIdx(SITES[s.id].canopy.length-1);setPlaying(false);clearInterval(playRef.current);}}
            style={{padding:"6px 14px",borderRadius:20,border:`1px solid ${s.id===selectedSite?"#0a2342":"#e2e8f0"}`,
              background:s.id===selectedSite?"#0a2342":"white",
              color:s.id===selectedSite?"white":"#64748b",cursor:"pointer",fontSize:12,fontWeight:600}}>
            {s.name}
          </button>
        ))}
        <div style={{marginLeft:"auto",display:"flex",gap:8}}>
          <button onClick={exportCSV}
            style={{padding:"6px 14px",borderRadius:20,border:"1px solid #0e7490",background:"#f0f9ff",
              color:"#0e7490",cursor:"pointer",fontSize:12,fontWeight:600}}>
            ‚Üì Export CSV
          </button>
          <button onClick={()=>{
            const data=JSON.stringify({site:site.id,exported:"2024-06-25",dives:site.dives,canopy:site.canopy},null,2);
            const a=document.createElement("a");
            a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));
            a.download=`${site.id}_full_data.json`;a.click();
          }}
            style={{padding:"6px 14px",borderRadius:20,border:"1px solid #6b21a8",background:"#fdf4ff",
              color:"#6b21a8",cursor:"pointer",fontSize:12,fontWeight:600}}>
            ‚Üì Export JSON
          </button>
        </div>
      </div>

      {/* Row 1: Cell map + Canopy timeseries */}
      <div style={{display:"grid",gridTemplateColumns:"240px 1fr",gap:14}}>
        <div style={S.card}>
          <span style={S.label}>Cell Activity Map ‚Äî {site.name}</span>
          <CellGridMap site={site}/>
          <div style={{marginTop:8,display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4}}>
            {CELLS.map(c=>(
              <div key={c} style={{textAlign:"center",padding:"4px",background:"#f8fafc",borderRadius:5}}>
                <div style={{fontSize:10,color:"#94a3b8",fontWeight:600}}>Cell {c}</div>
                <div style={{fontSize:12,fontWeight:700,color:"#0a2342"}}>{(cellTotals[c]||0).toLocaleString()}</div>
              </div>
            ))}
          </div>
        </div>

        <div style={S.card}>
          <span style={S.label}>Canopy Recovery ‚Äî Full History ({site.canopy[0].month} ‚Äì {site.canopy[site.canopy.length-1].month})</span>
          <ResponsiveContainer width="100%" height={180}>
            <AreaChart data={site.canopy} margin={{top:8,right:8,bottom:0,left:-14}}>
              <defs>
                <linearGradient id="cg" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stopColor="#16a34a" stopOpacity={0.3}/>
                  <stop offset="100%" stopColor="#16a34a" stopOpacity={0.02}/>
                </linearGradient>
                <linearGradient id="dg" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stopColor="#94a3b8" stopOpacity={0.3}/>
                  <stop offset="100%" stopColor="#94a3b8" stopOpacity={0.02}/>
                </linearGradient>
              </defs>
              <CartesianGrid stroke="#f1f5f9" vertical={false}/>
              <XAxis dataKey="month" tick={{fontSize:9,fill:"#94a3b8"}} tickLine={false} axisLine={false} interval={1}/>
              <YAxis tick={{fontSize:9,fill:"#94a3b8"}} tickLine={false} axisLine={false}
                tickFormatter={v=>`${v}ha`} width={32}/>
              <RTooltip contentStyle={ttStyle} formatter={v=>[`${v} ha`,"Canopy"]}/>
              {site.canopyDied?.map((d,i)=>(
                <ReferenceLine key={i} x={d.start} stroke="#94a3b8" strokeDasharray="4,3" strokeWidth={1}
                  label={{value:"Loss period",position:"insideTopRight",fontSize:8,fill:"#94a3b8"}}/>
              ))}
              {/* Gray "died" area ‚Äî approximate via second dataset */}
              <Area type="monotone" dataKey="ha" stroke="#16a34a" strokeWidth={2.5}
                fill="url(#cg)" dot={{r:3,fill:"#16a34a"}} activeDot={{r:5}}/>
              {/* Dive event lines */}
              {site.dives.map((d,i)=>{
                const m=new Date(d.date).toLocaleString("en-US",{month:"short",year:"2-digit"}).replace(" "," ");
                return<ReferenceLine key={i} x={m} stroke="#0e7490" strokeWidth={1} strokeOpacity={0.4}/>;
              })}
            </AreaChart>
          </ResponsiveContainer>
          <div style={{fontSize:10,color:"#94a3b8",marginTop:4}}>
            Teal vertical lines = dive events ¬∑ Gray dashed = historical loss period
          </div>
        </div>
      </div>

      {/* Row 2: Urchin cull bars + replay map */}
      <div style={{display:"grid",gridTemplateColumns:"1fr 260px",gap:14}}>
        <div style={S.card}>
          <span style={S.label}>Urchins Removed per Dive ¬∑ {site.name}</span>
          <ResponsiveContainer width="100%" height={160}>
            <BarChart data={cumulData} margin={{top:4,right:8,bottom:0,left:-14}}>
              <CartesianGrid stroke="#f1f5f9" vertical={false}/>
              <XAxis dataKey="date" tick={{fontSize:9,fill:"#94a3b8"}} tickLine={false} axisLine={false}/>
              <YAxis tick={{fontSize:9,fill:"#94a3b8"}} tickLine={false} axisLine={false} width={36}/>
              <RTooltip contentStyle={ttStyle}/>
              <Bar dataKey="urchins" fill="#0e7490" radius={[3,3,0,0]} name="Urchins"/>
              <Bar dataKey="diverHours" fill="#4d7c0f" radius={[3,3,0,0]} name="Diver-hrs" yAxisId={0} opacity={0.5}/>
              <Legend iconSize={8} wrapperStyle={{fontSize:10}}/>
            </BarChart>
          </ResponsiveContainer>
        </div>

        <div style={S.card}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
            <span style={S.label}>Kelp Recovery Replay</span>
            <button onClick={togglePlay}
              style={{padding:"4px 12px",borderRadius:6,border:"1px solid #0a2342",
                background:playing?"#fef2f2":"#0a2342",color:playing?"#dc2626":"white",
                cursor:"pointer",fontSize:11,fontWeight:600}}>
              {playing?"‚èπ Stop":"‚ñ∂ Play"}
            </button>
          </div>
          <ReplayMap site={site} replayIdx={replayIdx}/>
          <input type="range" min={0} max={site.canopy.length-1} value={replayIdx}
            onChange={e=>{clearInterval(playRef.current);setPlaying(false);setReplayIdx(parseInt(e.target.value));}}
            style={{width:"100%",marginTop:6,accentColor:"#16a34a"}}/>
          <div style={{display:"flex",justifyContent:"space-between",fontSize:9,color:"#94a3b8",marginTop:2}}>
            <span>{site.canopy[0].month}</span>
            <span style={{color:"#16a34a",fontWeight:600}}>{site.canopy[replayIdx]?.month}</span>
            <span>{site.canopy[site.canopy.length-1].month}</span>
          </div>
          <div style={{marginTop:8,display:"flex",gap:10,fontSize:9}}>
            <span style={{display:"flex",alignItems:"center",gap:4}}>
              <span style={{width:10,height:10,borderRadius:"50%",background:"rgba(22,163,74,0.5)",display:"inline-block"}}/>
              Live canopy</span>
            <span style={{display:"flex",alignItems:"center",gap:4}}>
              <span style={{width:10,height:10,borderRadius:"50%",background:"rgba(148,163,184,0.4)",display:"inline-block"}}/>
              Historical loss</span>
          </div>
        </div>
      </div>

      {/* Row 3: Efficiency + cross-site comparison */}
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}>
        <div style={S.card}>
          <span style={S.label}>Diver-Hours ‚Üí Kelp Hectares Recovered</span>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:12}}>
            {[
              {l:"Total Diver-Hrs",v:site.dives.reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0).toFixed(1),u:"hrs"},
              {l:"Canopy Gained",v:(site.canopy[site.canopy.length-1].ha-site.canopy[0].ha).toFixed(2),u:"ha"},
              {l:"Efficiency",v:eff||"‚Äî",u:eff?"hrs/ha":""},
            ].map(item=>(
              <div key={item.l} style={{textAlign:"center",padding:"10px 8px",background:"#f8fafc",borderRadius:8,border:"1px solid #e2e8f0"}}>
                <div style={{fontSize:20,fontWeight:800,color:"#0a2342",lineHeight:1}}>{item.v}
                  <span style={{fontSize:10,fontWeight:400,color:"#94a3b8",marginLeft:2}}>{item.u}</span></div>
                <div style={{fontSize:9,color:"#94a3b8",fontWeight:600,marginTop:3,textTransform:"uppercase",letterSpacing:"0.05em"}}>{item.l}</div>
              </div>
            ))}
          </div>
          <ResponsiveContainer width="100%" height={100}>
            <LineChart data={cumulData} margin={{top:4,right:8,bottom:0,left:-14}}>
              <CartesianGrid stroke="#f1f5f9" vertical={false}/>
              <XAxis dataKey="date" tick={{fontSize:8,fill:"#94a3b8"}} tickLine={false} axisLine={false}/>
              <YAxis tick={{fontSize:8,fill:"#94a3b8"}} tickLine={false} axisLine={false} width={32}/>
              <RTooltip contentStyle={ttStyle}/>
              <Line type="monotone" dataKey="cumulative" stroke="#0e7490" strokeWidth={2}
                dot={false} name="Cumulative urchins"/>
            </LineChart>
          </ResponsiveContainer>
          <div style={{fontSize:10,color:"#94a3b8",marginTop:3}}>Cumulative urchins removed over program lifetime</div>
        </div>

        <div style={S.card}>
          <span style={S.label}>Cross-Site Canopy Comparison</span>
          <ResponsiveContainer width="100%" height={150}>
            <BarChart data={siteComp} layout="vertical" margin={{top:0,right:16,bottom:0,left:40}}>
              <CartesianGrid stroke="#f1f5f9" horizontal={false}/>
              <XAxis type="number" tick={{fontSize:9,fill:"#94a3b8"}} tickLine={false} axisLine={false}
                tickFormatter={v=>`${v}ha`}/>
              <YAxis type="category" dataKey="name" tick={{fontSize:10,fill:"#334155"}} width={44} axisLine={false} tickLine={false}/>
              <RTooltip contentStyle={ttStyle} formatter={(v,n)=>[`${v}`,n]}/>
              <Bar dataKey="gain" fill="#16a34a" radius={[0,3,3,0]} name="Ha gained" opacity={0.85}/>
              <Bar dataKey="ha" fill="#0e7490" radius={[0,3,3,0]} name="Current ha" opacity={0.5}/>
              <Legend iconSize={8} wrapperStyle={{fontSize:10}}/>
            </BarChart>
          </ResponsiveContainer>
          <div style={{marginTop:10,display:"flex",flexDirection:"column",gap:5}}>
            {siteComp.map(s=>(
              <div key={s.name} style={{display:"flex",justifyContent:"space-between",fontSize:11,
                padding:"4px 0",borderBottom:"1px solid #f1f5f9"}}>
                <span style={{color:"#334155",fontWeight:500}}>{s.name}</span>
                <span style={{color:"#0a2342",fontWeight:600,fontVariantNumeric:"tabular-nums"}}>
                  {s.hrs}h ¬∑ {s.dives} dives ¬∑ {s.gain>0?"+":""}{s.gain} ha
                </span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP SHELL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TABS=[
  {id:"status",label:"Site Status & Dive Planning",icon:"üó∫"},
  {id:"input",label:"Dive Input",icon:"ü§ø"},
  {id:"impact",label:"Impact & Long-Term Evaluation",icon:"üìä"},
];

export default function KelpDashboard(){
  const [tab,setTab]=useState("status");
  const [selectedSite,setSelectedSite]=useState("caspar");
  const totals=getProgramTotals();

  return(
    <div style={{height:"100vh",display:"flex",flexDirection:"column",
      fontFamily:"'DM Sans',system-ui,sans-serif",background:"#f1f5f9",overflow:"hidden"}}>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Fraunces:wght@600;700&display=swap');
        *{box-sizing:border-box;margin:0;}
        ::-webkit-scrollbar{width:5px;}
        ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px;}
        input,select,textarea{font-family:inherit;transition:border-color 0.15s;}
        input:focus,select:focus,textarea:focus{border-color:#0e7490 !important;outline:none;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
        .pg{animation:fadeIn 0.2s ease both;}
      `}</style>

      {/* HEADER */}
      <header style={{background:"linear-gradient(135deg,#0a2342 0%,#0d3460 100%)",
        padding:"0 20px",height:58,display:"flex",alignItems:"center",justifyContent:"space-between",
        flexShrink:0,boxShadow:"0 2px 16px rgba(10,35,66,0.4)",position:"relative",overflow:"hidden"}}>
        <svg style={{position:"absolute",right:0,top:0,opacity:0.05,pointerEvents:"none"}} width="500" height="58" viewBox="0 0 500 58">
          {[0,1,2,3,4].map(i=>(
            <path key={i} d={`M${i*100},29 Q${i*100+25},${17+i*2} ${i*100+50},29 Q${i*100+75},${41-i*2} ${i*100+100},29`}
              stroke="white" strokeWidth={3.2-i*0.35} fill="none"/>
          ))}
        </svg>
        <div style={{display:"flex",alignItems:"center",gap:11,zIndex:1}}>
          <div style={{width:34,height:34,borderRadius:9,background:"rgba(255,255,255,0.1)",
            display:"flex",alignItems:"center",justifyContent:"center",fontSize:19,
            border:"1px solid rgba(255,255,255,0.15)",flexShrink:0}}>üåø</div>
          <div>
            <div style={{fontSize:14,fontWeight:700,color:"#fff",fontFamily:"'Fraunces',Georgia,serif",letterSpacing:"-0.01em"}}>
              California Kelp Restoration Initiative
            </div>
            <div style={{fontSize:9,color:"rgba(255,255,255,0.4)",letterSpacing:"0.09em",textTransform:"uppercase"}}>
              Mendocino County Field Operations Dashboard
            </div>
          </div>
        </div>
        <div style={{display:"flex",gap:7,zIndex:1}}>
          {[
            {l:"Diver-Hours",v:totals.hrs,u:"hrs",a:"#38bdf8"},
            {l:"Urchins Culled",v:totals.urchins.toLocaleString(),u:"",a:"#fb923c"},
            {l:"Ha Recovered",v:totals.ha,u:"ha",a:"#86efac"},
            {l:"Total Dives",v:totals.dives,u:"",a:"#c084fc"},
          ].map(k=>(
            <div key={k.l} style={{padding:"5px 11px",borderRadius:8,
              background:"rgba(255,255,255,0.08)",border:"1px solid rgba(255,255,255,0.12)",minWidth:80}}>
              <div style={{fontSize:8.5,color:"rgba(255,255,255,0.4)",textTransform:"uppercase",letterSpacing:"0.07em",fontWeight:600}}>{k.l}</div>
              <div style={{fontSize:17,fontWeight:800,color:k.a,lineHeight:1.3,marginTop:1}}>
                {k.v}<span style={{fontSize:9,fontWeight:500,color:"rgba(255,255,255,0.35)",marginLeft:2}}>{k.u}</span>
              </div>
            </div>
          ))}
        </div>
      </header>

      {/* TAB NAV */}
      <div style={{background:"#fff",borderBottom:"1px solid #e2e8f0",display:"flex",
        padding:"0 20px",flexShrink:0,boxShadow:"0 1px 4px rgba(0,0,0,0.04)"}}>
        {TABS.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)}
            style={{padding:"12px 18px",background:"transparent",border:"none",
              borderBottom:`2.5px solid ${tab===t.id?"#0e7490":"transparent"}`,
              cursor:"pointer",fontSize:13,fontWeight:tab===t.id?700:500,
              color:tab===t.id?"#0a2342":"#94a3b8",display:"flex",alignItems:"center",
              gap:7,transition:"all 0.15s",marginBottom:-1,whiteSpace:"nowrap"}}>
            <span>{t.icon}</span>{t.label}
          </button>
        ))}
      </div>

      {/* PAGE CONTENT */}
      <div style={{flex:1,minHeight:0,overflow:"hidden"}} className="pg" key={tab}>
        {tab==="status"&&<Page1 selectedSite={selectedSite} setSelectedSite={setSelectedSite}/>}
        {tab==="input"&&<Page2 selectedSite={selectedSite} setSelectedSite={setSelectedSite}/>}
        {tab==="impact"&&<Page3 selectedSite={selectedSite} setSelectedSite={setSelectedSite}/>}
      </div>

      {/* FOOTER */}
      <footer style={{background:"#0a2342",padding:"5px 20px",display:"flex",
        justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
        <p style={{fontSize:8.5,color:"rgba(255,255,255,0.3)"}}>
          Canopy data: KelpWatch / Landsat ¬∑ Dive data: field logs ¬∑ Demo site: Caspar Cove, Mendocino County
        </p>
        <p style={{fontSize:8.5,color:"rgba(255,255,255,0.2)"}}>
          California Kelp Restoration Initiative ¬∑ v2.0 ¬∑ Data through Jun 2024
        </p>
      </footer>
    </div>
  );
}