<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>California Kelp Restoration Initiative</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --navy:#0a2342;--navy2:#0d3460;--teal:#0e7490;--teal-lt:#f0f9ff;
  --green:#16a34a;--green-lt:#f0fdf4;--green-border:#86efac;
  --amber:#d97706;--red:#dc2626;
  --slate:#334155;--muted:#64748b;--label:#94a3b8;
  --border:#e2e8f0;--bg:#f8fafc;--white:#fff;
}
html,body{height:100%;font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);}
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px;}
input,select,textarea{font-family:inherit;}
input:focus,select:focus,textarea:focus{border-color:var(--teal)!important;outline:none;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app{height:100vh;display:flex;flex-direction:column;overflow:hidden;}
#header{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);padding:0 20px;height:56px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 16px rgba(10,35,66,0.4);}
#header-left{display:flex;align-items:center;gap:10px;}
.header-icon{width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;font-size:18px;border:1px solid rgba(255,255,255,0.15);}
.header-title{font-size:14px;font-weight:700;color:#fff;letter-spacing:-0.01em;}
.header-sub{font-size:9px;color:rgba(255,255,255,0.4);letter-spacing:0.09em;text-transform:uppercase;}
#header-stats{display:flex;gap:7px;}
.hstat{padding:5px 11px;border-radius:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);min-width:78px;}
.hstat-label{font-size:8.5px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.07em;font-weight:600;}
.hstat-val{font-size:17px;font-weight:800;line-height:1.3;margin-top:1px;}
.hstat-unit{font-size:9px;font-weight:500;color:rgba(255,255,255,0.35);margin-left:2px;}

#tabnav{background:var(--white);border-bottom:1px solid var(--border);display:flex;padding:0 20px;flex-shrink:0;}
.tab{padding:12px 18px;background:transparent;border:none;border-bottom:2.5px solid transparent;cursor:pointer;font-size:13px;font-weight:500;color:var(--label);display:flex;align-items:center;gap:7px;margin-bottom:-1px;white-space:nowrap;font-family:inherit;}
.tab.active{font-weight:700;color:var(--navy);border-bottom-color:var(--teal);}
.tab:hover{color:var(--slate);}

#pages{flex:1;min-height:0;overflow:hidden;}
.page{display:none;height:100%;}
.page.active{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--white);border-radius:12px;padding:14px 16px;border:1px solid var(--border);}
.clabel{font-size:10px;font-weight:700;color:var(--label);text-transform:uppercase;letter-spacing:0.07em;display:block;margin-bottom:6px;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;}

/* ‚îÄ‚îÄ PAGE 1 ‚îÄ‚îÄ */
#p1{flex-direction:row!important;}
#p1-map{width:52%;background:#c8e6f4;border-right:1px solid var(--border);position:relative;overflow:hidden;}
#p1-map svg{display:block;width:100%;height:100%;}
#map-legend{position:absolute;bottom:12px;left:12px;background:rgba(255,255,255,0.95);border-radius:8px;padding:8px 12px;border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,0.1);}
#map-legend h4{font-size:9px;font-weight:700;color:var(--label);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;}
.leg-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:10px;}
.leg-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0;}
.leg-row span{color:#475569;font-weight:500;}
.leg-hint{margin-top:6px;padding-top:6px;border-top:1px solid #f1f5f9;font-size:9px;color:var(--label);}

#p1-detail{width:48%;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.site-breadcrumb{font-size:11px;color:var(--label);margin-bottom:2px;}
.site-breadcrumb .crumb{cursor:pointer;font-weight:400;color:var(--label);}
.site-breadcrumb .crumb.active{font-weight:700;color:var(--navy);border-bottom:2px solid var(--teal);}
.site-breadcrumb .sep{margin:0 4px;opacity:0.4;}
.site-name{font-size:20px;font-weight:700;color:var(--navy);margin:4px 0 2px;letter-spacing:-0.02em;}
.site-sub{font-size:12px;color:var(--muted);}
.cond-tile{background:var(--white);border-radius:12px;padding:10px 12px;border:1px solid var(--border);}
.cond-lbl{font-size:9px;font-weight:700;color:var(--label);text-transform:uppercase;letter-spacing:0.07em;display:block;margin-bottom:3px;}
.cond-val{font-size:16px;font-weight:800;color:var(--navy);line-height:1;}
.cond-sub{font-size:11px;color:var(--label);margin-top:2px;}
.suit-bar-wrap{height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;margin-bottom:10px;}
.suit-bar{height:100%;border-radius:4px;transition:width 0.8s ease;}
.suit-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 16px;}
.suit-row{font-size:11px;display:flex;justify-content:space-between;}
.suit-row .sk{color:var(--label);}
.suit-row .sv{color:var(--slate);font-weight:500;}
.activity-box{text-align:center;padding:8px 6px;background:var(--bg);border-radius:8px;border:1px solid var(--border);}
.activity-num{font-size:20px;font-weight:800;color:var(--navy);line-height:1;}
.activity-lbl{font-size:9px;color:var(--label);font-weight:600;margin-top:3px;text-transform:uppercase;letter-spacing:0.06em;}
.exit-card{padding:8px 10px;border-radius:8px;background:var(--bg);margin-bottom:6px;border:1px solid var(--border);}
.exit-meta{display:flex;justify-content:space-between;margin-bottom:4px;}
.exit-date{font-size:10px;color:var(--label);font-family:monospace;}
.exit-badge{font-size:10px;font-weight:600;padding:1px 7px;border-radius:10px;}
.exit-text{font-size:12px;color:var(--slate);line-height:1.5;}

/* ‚îÄ‚îÄ PAGE 2 ‚îÄ‚îÄ */
#p2{flex-direction:row!important;}
#p2-sidebar{width:30%;background:#f0f4f8;border-right:1px solid var(--border);padding:20px 16px;overflow-y:auto;flex-shrink:0;}
#p2-form{flex:1;overflow-y:auto;padding:20px 24px;background:var(--white);}
.site-option{padding:10px 12px;border-radius:10px;cursor:pointer;margin-bottom:8px;background:var(--white);border:1px solid var(--border);color:var(--navy);}
.site-option.sel{background:var(--navy);border-color:var(--navy);color:var(--white);}
.site-option .so-name{font-weight:600;font-size:13px;}
.site-option .so-sub{font-size:11px;opacity:0.6;margin-top:2px;}
.import-panel{margin-top:20px;padding:14px;background:var(--white);border-radius:10px;border:1px solid var(--border);}
.import-btn{padding:9px 10px;border-radius:7px;border:1px solid var(--border);background:var(--white);cursor:pointer;text-align:left;width:100%;margin-bottom:6px;transition:background 0.15s;}
.import-btn:hover{background:var(--bg);}
.import-btn .ib-title{font-size:11px;font-weight:600;color:var(--navy);}
.import-btn .ib-fmt{font-size:9px;color:var(--label);margin-top:2px;}
.import-btn.uploading .ib-title{color:var(--label);}
.import-success{padding:6px 10px;background:var(--green-lt);border-radius:6px;border:1px solid var(--green-border);font-size:11px;color:#14532d;margin-bottom:8px;}
.section-title{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #f1f5f9;}
.field{display:flex;flex-direction:column;margin-bottom:0;}
.field label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.07em;display:block;margin-bottom:4px;}
.field input,.field select,.field textarea{width:100%;background:var(--white);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;color:var(--navy);outline:none;font-family:inherit;}
.field textarea{resize:vertical;}
.field input.autofilled{background:#f0fdf4;border-color:#86efac;}
.cell-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;background:#f0f9ff;border-radius:10px;padding:12px;border:1px solid #bae6fd;margin-bottom:10px;}
.cell-box{border-radius:8px;padding:8px;border:1.5px solid var(--border);background:rgba(14,116,144,0.04);transition:all 0.2s;}
.cell-box.has-val{border-color:var(--teal);}
.cell-box .cell-label{font-size:10px;font-weight:700;color:var(--navy);margin-bottom:4px;}
.cell-box input{width:100%;text-align:center;padding:6px 4px;font-size:14px;font-weight:700;border-radius:6px;border:1px solid var(--border);background:#fafafa;outline:none;}
.cell-box.has-val input{border-color:var(--teal);}
.cell-box .cell-count{font-size:9px;color:var(--teal);text-align:center;margin-top:3px;font-weight:600;}
.total-bar{padding:8px 12px;background:var(--green-lt);border-radius:8px;border:1px solid var(--green-border);display:flex;justify-content:space-between;align-items:center;}
.total-bar .tl{font-size:12px;color:#14532d;font-weight:600;}
.total-bar .tv{font-size:18px;font-weight:800;color:#15803d;}
.submit-btn{padding:12px 32px;border-radius:10px;background:var(--navy);color:var(--white);border:none;cursor:pointer;font-size:15px;font-weight:700;font-family:inherit;}
.submit-btn:hover{background:var(--teal);}
.success-screen{display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;padding:40px;text-align:center;}
.success-screen.show{display:flex;}
.success-emoji{font-size:48px;}
.success-title{font-size:22px;font-weight:700;color:var(--navy);}
.success-msg{font-size:14px;color:var(--muted);max-width:360px;line-height:1.6;}
.log-again-btn{padding:10px 28px;border-radius:8px;background:var(--navy);color:var(--white);border:none;cursor:pointer;font-size:14px;font-weight:600;font-family:inherit;}

/* ‚îÄ‚îÄ PAGE 3 ‚îÄ‚îÄ */
#p3{overflow-y:auto;padding:20px;background:var(--bg);}
.site-tabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;}
.site-tab{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:var(--white);color:var(--muted);cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;}
.site-tab.active{background:var(--navy);border-color:var(--navy);color:var(--white);}
.export-btns{margin-left:auto;display:flex;gap:8px;}
.export-btn{padding:6px 14px;border-radius:20px;border:1px solid var(--teal);background:var(--teal-lt);color:var(--teal);cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;}
.export-btn.json{border-color:#6b21a8;background:#fdf4ff;color:#6b21a8;}
.p3-row{display:grid;gap:14px;margin-bottom:14px;}
.p3-row.r2{grid-template-columns:250px 1fr;}
.p3-row.r3{grid-template-columns:1fr 260px;}
.p3-row.r4{grid-template-columns:1fr 1fr;}
.chart-wrap{position:relative;}
.replay-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.play-btn{padding:4px 12px;border-radius:6px;border:1px solid var(--navy);background:var(--navy);color:var(--white);cursor:pointer;font-size:11px;font-weight:600;font-family:inherit;}
.play-btn.stop{background:#fef2f2;color:var(--red);}
input[type=range]{width:100%;margin-top:6px;accent-color:var(--green);}
.replay-timestamps{display:flex;justify-content:space-between;font-size:9px;color:var(--label);margin-top:2px;}
.replay-current{color:var(--green);font-weight:600;}
.replay-legend{margin-top:8px;display:flex;gap:10px;font-size:9px;}
.replay-legend span{display:flex;align-items:center;gap:4px;}
.replay-legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
.eff-boxes{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.eff-box{text-align:center;padding:10px 8px;background:var(--bg);border-radius:8px;border:1px solid var(--border);}
.eff-num{font-size:20px;font-weight:800;color:var(--navy);line-height:1;}
.eff-unit{font-size:10px;font-weight:400;color:var(--label);margin-left:2px;}
.eff-lbl{font-size:9px;color:var(--label);font-weight:600;margin-top:3px;text-transform:uppercase;letter-spacing:0.05em;}
.site-compare-row{display:flex;justify-content:space-between;font-size:11px;padding:4px 0;border-bottom:1px solid #f1f5f9;}
.site-compare-row .scn{color:var(--slate);font-weight:500;}
.site-compare-row .scv{color:var(--navy);font-weight:600;}
.cell-totals{margin-top:8px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;}
.ct-box{text-align:center;padding:4px;background:var(--bg);border-radius:5px;}
.ct-lbl{font-size:10px;color:var(--label);font-weight:600;}
.ct-val{font-size:12px;font-weight:700;color:var(--navy);}
.chart-hint{font-size:10px;color:var(--label);margin-top:4px;}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
#footer{background:var(--navy);padding:5px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
#footer p{font-size:8.5px;}
#footer p:first-child{color:rgba(255,255,255,0.3);}
#footer p:last-child{color:rgba(255,255,255,0.2);}

@media(max-width:900px){
  #header-stats{display:none;}
  #p1-map{width:45%;}#p1-detail{width:55%;}
  .p3-row.r2,.p3-row.r3,.p3-row.r4{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div id="app">

<!-- HEADER -->
<header id="header">
  <div id="header-left">
    <div class="header-icon">üåø</div>
    <div>
      <div class="header-title">California Kelp Restoration Initiative</div>
      <div class="header-sub">Mendocino County Field Operations Dashboard</div>
    </div>
  </div>
  <div id="header-stats">
    <div class="hstat"><div class="hstat-label">Diver-Hours</div><div class="hstat-val" style="color:#38bdf8" id="hs-hrs">‚Äî<span class="hstat-unit">hrs</span></div></div>
    <div class="hstat"><div class="hstat-label">Urchins Culled</div><div class="hstat-val" style="color:#fb923c" id="hs-urchins">‚Äî</div></div>
    <div class="hstat"><div class="hstat-label">Ha Recovered</div><div class="hstat-val" style="color:#86efac" id="hs-ha">‚Äî<span class="hstat-unit">ha</span></div></div>
    <div class="hstat"><div class="hstat-label">Total Dives</div><div class="hstat-val" style="color:#c084fc" id="hs-dives">‚Äî</div></div>
  </div>
</header>

<!-- TAB NAV -->
<nav id="tabnav">
  <button class="tab active" data-tab="p1">üó∫ Site Status &amp; Dive Planning</button>
  <button class="tab" data-tab="p2">ü§ø Dive Input</button>
  <button class="tab" data-tab="p3">üìä Impact &amp; Long-Term Evaluation</button>
</nav>

<!-- PAGES -->
<div id="pages">

  <!-- PAGE 1 -->
  <div class="page active" id="p1">
    <div id="p1-map">
      <svg id="coast-map" viewBox="0 0 480 360" preserveAspectRatio="xMidYMid meet"></svg>
      <div id="map-legend">
        <h4>Dive Suitability</h4>
        <div class="leg-row"><span class="leg-dot" style="background:#16a34a"></span><span>Excellent</span></div>
        <div class="leg-row"><span class="leg-dot" style="background:#0e7490"></span><span>Good</span></div>
        <div class="leg-row"><span class="leg-dot" style="background:#d97706"></span><span>Marginal</span></div>
        <div class="leg-row"><span class="leg-dot" style="background:#dc2626"></span><span>Poor</span></div>
        <div class="leg-hint">Click site to view details</div>
      </div>
    </div>
    <div id="p1-detail">
      <div>
        <div class="site-breadcrumb" id="p1-breadcrumb"></div>
        <div class="site-name" id="p1-sitename"></div>
        <div class="site-sub" id="p1-sitesub"></div>
      </div>
      <div class="grid4" id="p1-condtiles"></div>
      <div class="card" id="p1-suitcard">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span class="clabel" style="margin:0">Dive Suitability Today</span>
          <span id="p1-suit-label" style="font-size:13px;font-weight:700;"></span>
        </div>
        <div class="suit-bar-wrap"><div class="suit-bar" id="p1-suit-bar"></div></div>
        <div class="suit-grid" id="p1-suit-grid"></div>
      </div>
      <div class="card">
        <span class="clabel">90-Day Activity Summary</span>
        <div class="grid3" id="p1-activity" style="margin-bottom:12px;"></div>
        <div id="p1-lastdive" style="font-size:11px;color:var(--muted);"></div>
      </div>
      <div class="card">
        <span class="clabel">Recent Exit Form Comments</span>
        <div id="p1-comments"></div>
      </div>
    </div>
  </div>

  <!-- PAGE 2 -->
  <div class="page" id="p2">
    <div id="p2-sidebar">
      <div class="clabel" style="margin-bottom:12px;">Select Site</div>
      <div id="p2-sites"></div>
      <div class="import-panel">
        <div class="clabel">Import Dive Data</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:10px;line-height:1.5;">Auto-fill from your dive computer or app. Date, depth, bottom time and water temp pre-populated.</p>
        <div id="import-success" class="import-success" style="display:none;"></div>
        <button class="import-btn" onclick="simulateImport('Garmin/Suunto')"><div class="ib-title">ü§ø Garmin / Suunto Watch</div><div class="ib-fmt">UDDF, Garmin FIT</div></button>
        <button class="import-btn" onclick="simulateImport('PADI')"><div class="ib-title">üì± PADI Dive Log App</div><div class="ib-fmt">PADI JSON export</div></button>
        <button class="import-btn" onclick="simulateImport('Subsurface')"><div class="ib-title">üåä Subsurface / DiveLogs</div><div class="ib-fmt">UDDF, UDCF</div></button>
        <button class="import-btn" onclick="document.getElementById('uddf-upload').click()">
          <div class="ib-title">üìé Upload UDDF / CSV / FIT</div>
          <div class="ib-fmt">Universal Dive Data Format</div>
        </button>
        <input type="file" id="uddf-upload" accept=".uddf,.csv,.xml,.fit" style="display:none" onchange="simulateImport('uploaded file')"/>
      </div>
    </div>
    <div id="p2-form">
      <div id="form-inner">
        <h2 style="font-size:18px;font-weight:700;color:var(--navy);margin-bottom:4px;">Post-Dive Exit Form</h2>
        <p id="form-subtitle" style="font-size:12px;color:var(--muted);margin-bottom:20px;"></p>
        <div style="margin-bottom:18px;">
          <div class="section-title">Diver Information</div>
          <div class="grid3">
            <div class="field"><label>Lead Diver Name *</label><input type="text" id="f-name" placeholder="Full name"/></div>
            <div class="field"><label>Email</label><input type="email" id="f-email" placeholder="you@example.com"/></div>
            <div class="field"><label>Total Divers in Group *</label><input type="number" id="f-group" min="1" placeholder="Including yourself"/></div>
          </div>
        </div>
        <div style="background:var(--bg);border-radius:10px;padding:14px 16px;border:1px solid var(--border);margin-bottom:18px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <span style="font-size:12px;font-weight:700;color:var(--navy);">Dive Metadata</span>
            <span id="import-tag" style="font-size:10px;color:var(--label);font-style:italic;">Use import ‚Üê to auto-fill</span>
          </div>
          <div class="grid4">
            <div class="field"><label>Dive Date *</label><input type="date" id="f-date"/></div>
            <div class="field"><label>Max Depth (ft)</label><input type="number" id="f-depth" placeholder="e.g. 32"/></div>
            <div class="field"><label>Bottom Time (min)</label><input type="number" id="f-time" placeholder="e.g. 48"/></div>
            <div class="field"><label>Water Temp (¬∞F)</label><input type="number" id="f-temp" placeholder="e.g. 53"/></div>
          </div>
        </div>
        <div style="margin-bottom:18px;">
          <div class="section-title">Dive Conditions</div>
          <div class="grid3">
            <div class="field"><label>Visibility (ft)</label><input type="number" id="f-vis" placeholder="e.g. 18"/></div>
            <div class="field"><label>Surge</label>
              <select id="f-surge">
                <option value="light">Light</option>
                <option value="moderate" selected>Moderate</option>
                <option value="moderate-heavy">Moderate-Heavy</option>
                <option value="heavy">Heavy</option>
              </select>
            </div>
            <div class="field"><label>Exit Conditions</label>
              <select id="f-exit">
                <option>Excellent</option>
                <option selected>Good</option>
                <option>Fair</option>
                <option>Difficult</option>
              </select>
            </div>
          </div>
        </div>
        <div style="margin-bottom:18px;">
          <div class="section-title">Urchins Culled by Cell *</div>
          <p style="font-size:11px;color:var(--label);margin-bottom:10px;">Enter count per cell worked. Leave blank if not dived.</p>
          <div class="cell-grid" id="cell-inputs"></div>
          <div class="total-bar"><span class="tl">Session Total</span><span class="tv" id="cell-total">0 urchins</span></div>
        </div>
        <div class="field" style="margin-bottom:24px;"><label>Field Notes &amp; Observations</label>
          <textarea id="f-comments" rows="3" placeholder="Kelp recruits observed, unusual species, GPS coords, substrate notes‚Ä¶"></textarea>
        </div>
        <button class="submit-btn" onclick="submitForm()">Submit Dive Log ‚Üí</button>
      </div>
      <div class="success-screen" id="success-screen">
        <div class="success-emoji">üåø</div>
        <div class="success-title">Dive logged!</div>
        <div class="success-msg" id="success-msg"></div>
        <button class="log-again-btn" onclick="resetForm()">Log Another Dive</button>
      </div>
    </div>
  </div>

  <!-- PAGE 3 -->
  <div class="page" id="p3">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px;" id="p3-tabs">
      <div class="export-btns">
        <button class="export-btn" onclick="exportCSV()">‚Üì CSV</button>
        <button class="export-btn json" onclick="exportJSON()">‚Üì JSON</button>
      </div>
    </div>
    <div class="p3-row r2">
      <div class="card">
        <span class="clabel" id="p3-cell-title">Cell Activity</span>
        <svg id="cell-map-svg" viewBox="0 0 240 190" width="100%" height="190"></svg>
        <div class="cell-totals" id="p3-cell-totals"></div>
      </div>
      <div class="card">
        <span class="clabel" id="p3-canopy-title">Canopy Recovery ‚Äî Full History</span>
        <div class="chart-wrap"><canvas id="canopy-chart" height="195"></canvas></div>
        <div class="chart-hint">Teal lines = dive events ¬∑ Gray dashed = loss period</div>
      </div>
    </div>
    <div class="p3-row r3">
      <div class="card">
        <span class="clabel">Urchins Removed per Dive</span>
        <div class="chart-wrap"><canvas id="urchin-chart" height="155"></canvas></div>
      </div>
      <div class="card">
        <div class="replay-controls">
          <span class="clabel" style="margin:0">Kelp Recovery Replay</span>
          <button class="play-btn" id="play-btn" onclick="togglePlay()">‚ñ∂ Play</button>
        </div>
        <svg id="replay-svg" viewBox="0 0 240 180" width="100%" height="180"></svg>
        <input type="range" id="replay-slider" min="0" value="0" oninput="onSlider(this.value)"/>
        <div class="replay-timestamps"><span id="rt-start"></span><span class="replay-current" id="rt-cur"></span><span id="rt-end"></span></div>
        <div class="replay-legend">
          <span><span class="dot" style="background:rgba(22,163,74,0.5)"></span>Live canopy</span>
          <span><span class="dot" style="background:rgba(148,163,184,0.4)"></span>Historical loss</span>
        </div>
      </div>
    </div>
    <div class="p3-row r4">
      <div class="card">
        <span class="clabel">Diver-Hours ‚Üí Kelp Hectares Recovered</span>
        <div class="eff-boxes" id="p3-eff-boxes"></div>
        <div class="chart-wrap"><canvas id="cumul-chart" height="100"></canvas></div>
        <div class="chart-hint">Cumulative urchins removed over program lifetime</div>
      </div>
      <div class="card">
        <span class="clabel">Cross-Site Canopy Comparison</span>
        <div class="chart-wrap"><canvas id="compare-chart" height="150"></canvas></div>
        <div id="p3-compare-list" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

</div><!-- /pages -->

<footer id="footer">
  <p>Canopy data: KelpWatch / Landsat ¬∑ Dive data: field logs ¬∑ Mendocino County, CA</p>
  <p>California Kelp Restoration Initiative ¬∑ Data through Jun 2024</p>
</footer>
</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CELLS = ["A","B","C","D","E","F"];
const SITES = {
  caspar:{id:"caspar",name:"Caspar Cove",lat:39.357,lng:-123.818,depthRange:"8‚Äì42 ft",
    canopy:[{m:"Jan 22",ha:0.2},{m:"Apr 22",ha:0.3},{m:"Jul 22",ha:0.3},{m:"Oct 22",ha:0.35},{m:"Jan 23",ha:0.4},{m:"Apr 23",ha:0.5},{m:"Jul 23",ha:1.1},{m:"Oct 23",ha:2.3},{m:"Jan 24",ha:3.8},{m:"Apr 24",ha:5.1},{m:"Jun 24",ha:5.6}],
    canopyDied:[{start:"Jan 22",end:"Apr 23"}],
    dives:[
      {date:"2023-02-11",divers:6,bottomTime:52,maxDepth:28,waterTemp:52,visibility:18,surge:"moderate",cells:{A:180,B:130},comments:"Dense barren in A. Great vis, mild surge.",exitConditions:"Good"},
      {date:"2023-03-04",divers:8,bottomTime:48,maxDepth:32,waterTemp:51,visibility:22,surge:"light",cells:{A:220,B:200},comments:"Kelp recruits spotted at NW edge Cell A.",exitConditions:"Excellent"},
      {date:"2023-04-22",divers:7,bottomTime:55,maxDepth:30,waterTemp:53,visibility:20,surge:"light",cells:{A:195,C:200},comments:"Expanded push into C. Rocky substrate exposed.",exitConditions:"Good"},
      {date:"2023-06-10",divers:5,bottomTime:50,maxDepth:26,waterTemp:55,visibility:15,surge:"moderate",cells:{A:140,B:125},comments:"Surge picked up mid-dive. Stayed shallow.",exitConditions:"Fair"},
      {date:"2023-08-19",divers:9,bottomTime:58,maxDepth:35,waterTemp:57,visibility:25,surge:"light",cells:{B:250,C:260},comments:"Best conditions of season. Large team, great output.",exitConditions:"Excellent"},
      {date:"2023-10-07",divers:6,bottomTime:47,maxDepth:28,waterTemp:54,visibility:18,surge:"moderate",cells:{A:150,B:130},comments:"Juvenile kelp confirmed in A ‚Äî 3 patches ~20cm.",exitConditions:"Good"},
      {date:"2024-01-13",divers:4,bottomTime:45,maxDepth:24,waterTemp:49,visibility:14,surge:"heavy",cells:{A:120,B:70},comments:"Heavy surge, cut dive short. Stayed in shallows.",exitConditions:"Difficult"},
      {date:"2024-03-02",divers:5,bottomTime:50,maxDepth:30,waterTemp:51,visibility:20,surge:"light",cells:{A:110,B:110},comments:"Maintenance pass. Kelp canopy in A now >1m, robust.",exitConditions:"Good"},
      {date:"2024-05-18",divers:5,bottomTime:48,maxDepth:29,waterTemp:54,visibility:22,surge:"light",cells:{A:100,C:105},comments:"Kelp A/B looking strong. Expanded cleaning in C.",exitConditions:"Excellent"},
    ],
    conditions:{sst:54,swell:"2‚Äì3 ft @ 12s",visibility:"18‚Äì22 ft",surge:"Light‚ÄìModerate",wind:"NW 8 kts"},
    cellGrid:{A:{lat:39.358,lng:-123.819},B:{lat:39.357,lng:-123.820},C:{lat:39.356,lng:-123.819},D:{lat:39.356,lng:-123.818},E:{lat:39.357,lng:-123.817},F:{lat:39.358,lng:-123.818}},
  },
  albion:{id:"albion",name:"Albion Cove",lat:39.227,lng:-123.771,depthRange:"10‚Äì35 ft",
    canopy:[{m:"Jan 22",ha:0.3},{m:"Apr 22",ha:0.4},{m:"Jul 22",ha:0.5},{m:"Oct 22",ha:0.55},{m:"Jan 23",ha:0.6},{m:"Apr 23",ha:0.9},{m:"Jul 23",ha:1.8},{m:"Oct 23",ha:3.1},{m:"Jan 24",ha:4.0},{m:"Apr 24",ha:4.7},{m:"Jun 24",ha:5.0}],
    canopyDied:[{start:"Jan 22",end:"Jan 23"}],
    dives:[
      {date:"2023-03-15",divers:5,bottomTime:50,maxDepth:24,waterTemp:52,visibility:20,surge:"light",cells:{A:160,B:125},comments:"Good conditions. Solid early effort.",exitConditions:"Good"},
      {date:"2023-05-28",divers:7,bottomTime:54,maxDepth:28,waterTemp:55,visibility:22,surge:"light",cells:{A:200,B:170},comments:"Best day yet. Clear water, light surge.",exitConditions:"Excellent"},
      {date:"2023-09-03",divers:6,bottomTime:49,maxDepth:26,waterTemp:56,visibility:19,surge:"moderate",cells:{B:180,C:130},comments:"Pushed into C. Some surge in afternoon.",exitConditions:"Good"},
      {date:"2024-02-17",divers:4,bottomTime:46,maxDepth:22,waterTemp:50,visibility:16,surge:"moderate",cells:{A:100,B:75},comments:"Maintenance only. A looking great.",exitConditions:"Fair"},
      {date:"2024-04-30",divers:5,bottomTime:51,maxDepth:26,waterTemp:53,visibility:21,surge:"light",cells:{A:110,C:105},comments:"Canopy expanding outward from A into B.",exitConditions:"Good"},
    ],
    conditions:{sst:53,swell:"2‚Äì4 ft @ 10s",visibility:"16‚Äì20 ft",surge:"Moderate",wind:"NW 12 kts"},
    cellGrid:{A:{lat:39.228,lng:-123.772},B:{lat:39.227,lng:-123.772},C:{lat:39.226,lng:-123.771},D:{lat:39.226,lng:-123.770},E:{lat:39.227,lng:-123.770},F:{lat:39.228,lng:-123.771}},
  },
  ptcabrillo:{id:"ptcabrillo",name:"Point Cabrillo",lat:39.348,lng:-123.826,depthRange:"12‚Äì50 ft",
    canopy:[{m:"Jan 22",ha:0.5},{m:"Apr 22",ha:0.45},{m:"Jul 22",ha:0.4},{m:"Oct 22",ha:0.35},{m:"Jan 23",ha:0.3},{m:"Apr 23",ha:0.4},{m:"Jul 23",ha:0.6},{m:"Oct 23",ha:1.0},{m:"Jan 24",ha:1.4},{m:"Apr 24",ha:1.6},{m:"Jun 24",ha:1.5}],
    canopyDied:[{start:"Jan 22",end:"Jan 23"}],
    dives:[
      {date:"2023-04-08",divers:4,bottomTime:48,maxDepth:36,waterTemp:51,visibility:18,surge:"moderate",cells:{A:130,B:100},comments:"Deep site. Urchin density still high in D/E.",exitConditions:"Fair"},
      {date:"2023-07-22",divers:5,bottomTime:52,maxDepth:40,waterTemp:55,visibility:20,surge:"light",cells:{B:160,C:130},comments:"Extended into deeper cells. Good conditions.",exitConditions:"Good"},
      {date:"2023-11-11",divers:3,bottomTime:44,maxDepth:32,waterTemp:52,visibility:14,surge:"moderate",cells:{A:95,B:60},comments:"Small team, limited output. Need bigger crew.",exitConditions:"Fair"},
    ],
    conditions:{sst:52,swell:"3‚Äì5 ft @ 11s",visibility:"12‚Äì18 ft",surge:"Moderate‚ÄìHeavy",wind:"NW 15 kts"},
    cellGrid:{A:{lat:39.349,lng:-123.827},B:{lat:39.348,lng:-123.827},C:{lat:39.347,lng:-123.826},D:{lat:39.347,lng:-123.825},E:{lat:39.348,lng:-123.825},F:{lat:39.349,lng:-123.826}},
  },
  russian:{id:"russian",name:"Russian Gulch",lat:39.329,lng:-123.802,depthRange:"6‚Äì38 ft",
    canopy:[{m:"Jan 22",ha:1.2},{m:"Apr 22",ha:1.0},{m:"Jul 22",ha:0.9},{m:"Oct 22",ha:0.8},{m:"Jan 23",ha:0.8},{m:"Apr 23",ha:0.6},{m:"Jul 23",ha:0.4},{m:"Oct 23",ha:0.3},{m:"Jan 24",ha:0.2},{m:"Apr 24",ha:0.2},{m:"Jun 24",ha:0.1}],
    canopyDied:[{start:"Jan 22",end:"Jun 24"}],
    dives:[
      {date:"2023-05-14",divers:3,bottomTime:42,maxDepth:22,waterTemp:52,visibility:12,surge:"heavy",cells:{A:100,B:80},comments:"Heavy surge, limited safe work. Site declining fast.",exitConditions:"Difficult"},
    ],
    conditions:{sst:52,swell:"4‚Äì6 ft @ 10s",visibility:"10‚Äì14 ft",surge:"Heavy",wind:"NW 18 kts"},
    cellGrid:{A:{lat:39.330,lng:-123.803},B:{lat:39.329,lng:-123.803},C:{lat:39.328,lng:-123.802},D:{lat:39.328,lng:-123.801},E:{lat:39.329,lng:-123.801},F:{lat:39.330,lng:-123.802}},
  },
  noyo:{id:"noyo",name:"Noyo Harbor",lat:39.427,lng:-123.802,depthRange:"14‚Äì55 ft",
    canopy:[{m:"Jan 22",ha:1.3},{m:"Apr 22",ha:1.2},{m:"Jul 22",ha:1.15},{m:"Oct 22",ha:1.1},{m:"Jan 23",ha:1.1},{m:"Apr 23",ha:1.0},{m:"Jul 23",ha:0.9},{m:"Oct 23",ha:0.8},{m:"Jan 24",ha:0.7},{m:"Apr 24",ha:0.7},{m:"Jun 24",ha:0.6}],
    canopyDied:[{start:"Jan 22",end:"Jun 24"}],
    dives:[],
    conditions:{sst:51,swell:"3‚Äì5 ft @ 12s",visibility:"10‚Äì15 ft",surge:"Moderate",wind:"NW 14 kts"},
    cellGrid:{A:{lat:39.428,lng:-123.803},B:{lat:39.427,lng:-123.803},C:{lat:39.426,lng:-123.802},D:{lat:39.426,lng:-123.801},E:{lat:39.427,lng:-123.801},F:{lat:39.428,lng:-123.802}},
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NOW = new Date("2024-06-25");
function daysSince(d){return Math.floor((NOW-new Date(d))/86400000);}
function recentDives(site,days=90){const cut=NOW-days*86400000;return site.dives.filter(d=>new Date(d.date)>=cut);}
function cellTotals(site){const t={};CELLS.forEach(c=>{t[c]=0;});site.dives.forEach(d=>Object.entries(d.cells||{}).forEach(([c,n])=>{t[c]=(t[c]||0)+n;}));return t;}
function siteEfficiency(site){const hrs=site.dives.reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0);const gain=site.canopy[site.canopy.length-1].ha-site.canopy[0].ha;return hrs>0&&gain>0?(hrs/gain).toFixed(1):null;}
function suitability(site){
  const c=site.conditions;let score=100;
  const sw=parseFloat(c.swell);if(sw>=5)score-=40;else if(sw>=3)score-=20;
  if(c.surge==="Heavy")score-=35;else if(c.surge==="Moderate‚ÄìHeavy")score-=20;else if(c.surge==="Moderate")score-=10;
  const vis=parseInt(c.visibility);if(vis<12)score-=20;else if(vis<16)score-=8;
  if(c.sst<50)score-=15;else if(c.sst<52)score-=5;
  score=Math.max(0,Math.min(100,score));
  const label=score>=75?"Excellent":score>=55?"Good":score>=35?"Marginal":"Poor";
  const color=score>=75?"#16a34a":score>=55?"#0e7490":score>=35?"#d97706":"#dc2626";
  return{score,label,color};
}
function programTotals(){
  const all=Object.values(SITES);
  return{
    hrs:Math.round(all.flatMap(s=>s.dives).reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0)),
    urchins:all.flatMap(s=>s.dives).reduce((s,d)=>s+Object.values(d.cells||{}).reduce((a,b)=>a+b,0),0),
    ha:all.reduce((s,site)=>s+Math.max(0,site.canopy[site.canopy.length-1].ha-site.canopy[0].ha),0).toFixed(1),
    dives:all.flatMap(s=>s.dives).length,
  };
}
const exitColor={Excellent:"#16a34a",Good:"#0e7490",Fair:"#d97706",Difficult:"#dc2626"};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SVG MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAP_W=480,MAP_H=360;
const BOUNDS={latMin:39.10,latMax:39.55,lngMin:-124.02,lngMax:-123.52};
function proj(lat,lng){
  return[
    (lng-BOUNDS.lngMin)/(BOUNDS.lngMax-BOUNDS.lngMin)*MAP_W,
    MAP_H-((lat-BOUNDS.latMin)/(BOUNDS.latMax-BOUNDS.latMin)*MAP_H)
  ];
}
const COAST=[[39.550,-123.690],[39.530,-123.710],[39.510,-123.730],[39.490,-123.755],[39.470,-123.768],[39.450,-123.780],[39.427,-123.802],[39.410,-123.815],[39.395,-123.822],[39.370,-123.826],[39.357,-123.818],[39.348,-123.826],[39.340,-123.818],[39.329,-123.802],[39.315,-123.798],[39.300,-123.797],[39.280,-123.787],[39.260,-123.782],[39.245,-123.775],[39.227,-123.771],[39.210,-123.762],[39.190,-123.750],[39.170,-123.738],[39.150,-123.726],[39.130,-123.714],[39.110,-123.700]];

function buildMap(){
  const svg=document.getElementById("coast-map");
  const coastPts=COAST.map(([la,ln])=>proj(la,ln).join(",")).join(" ");
  const landPoly=COAST.map(([la,ln])=>proj(la,ln).join(",")).join(" ")+` ${MAP_W},${MAP_H} ${MAP_W},0`;
  const shallowPts=COAST.map(([la,ln])=>{const[x,y]=proj(la,ln-0.025);return`${x},${y}`;}).join(" ");
  const revPts=[...COAST].reverse().map(([la,ln])=>proj(la,ln).join(",")).join(" ");

  svg.innerHTML=`
  <defs>
    <linearGradient id="og2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#c8e6f4"/><stop offset="100%" stop-color="#a4cfe8"/></linearGradient>
    <linearGradient id="lg2" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#e4ece0"/><stop offset="100%" stop-color="#cdd8c5"/></linearGradient>
    <linearGradient id="sf2" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#afd9f0" stop-opacity="0.65"/><stop offset="100%" stop-color="#a4cfe8" stop-opacity="0"/></linearGradient>
    <pattern id="wg2" x="0" y="0" width="26" height="26" patternUnits="userSpaceOnUse"><path d="M0,13 Q6.5,9 13,13 Q19.5,17 26,13" stroke="#86c4e0" stroke-width="0.35" fill="none" opacity="0.5"/></pattern>
    <clipPath id="mc"><rect width="${MAP_W}" height="${MAP_H}"/></clipPath>
  </defs>
  <g clip-path="url(#mc)">
    <rect width="${MAP_W}" height="${MAP_H}" fill="url(#og2)"/>
    <rect width="${MAP_W}" height="${MAP_H}" fill="url(#wg2)"/>
    <polyline points="${shallowPts} ${revPts}" fill="url(#sf2)" stroke="none"/>
    <polygon points="${landPoly}" fill="url(#lg2)"/>
    <polyline points="${coastPts}" fill="none" stroke="#7a9a72" stroke-width="1.6" stroke-linejoin="round"/>
    ${[39.2,39.3,39.4,39.5].map(lat=>{const[,y]=proj(lat,-124.02);return`<text x="4" y="${y+4}" font-size="7.5" fill="#4a9ab8" opacity="0.7" font-family="monospace">${lat.toFixed(1)}¬∞N</text>`;}).join("")}
    <text x="60" y="${MAP_H*0.55}" font-size="11" fill="#4488a8" opacity="0.5" font-style="italic" transform="rotate(-10,60,${MAP_H*0.55})">Pacific Ocean</text>
    <g transform="translate(${MAP_W-28},24)"><circle r="13" fill="white" opacity="0.85" stroke="#c8d4c0" stroke-width="1"/><text y="-14" text-anchor="middle" font-size="8" fill="#0a2342" font-weight="700">N</text><polygon points="0,-10 -3,0 0,3 3,0" fill="#0a2342" opacity="0.7"/><polygon points="0,10 -3,0 0,-3 3,0" fill="#94a3b8" opacity="0.5"/></g>
    <g id="site-dots"></g>
  </g>`;

  renderSiteDots();
}

function renderSiteDots(){
  const g=document.getElementById("site-dots");
  if(!g)return;
  g.innerHTML="";
  Object.values(SITES).forEach(site=>{
    const[mx,my]=proj(site.lat,site.lng);
    const suit=suitability(site);
    const isSel=site.id===currentSite;
    const r=isSel?12:9;
    const el=document.createElementNS("http://www.w3.org/2000/svg","g");
    el.style.cursor="pointer";
    el.addEventListener("click",()=>selectSite(site.id));
    el.addEventListener("mouseenter",()=>{
      const tip=el.querySelector(".tip");if(tip)tip.style.display="block";
    });
    el.addEventListener("mouseleave",()=>{
      const tip=el.querySelector(".tip");if(tip)tip.style.display="none";
    });
    const lw=site.name.length*5.4+12;
    el.innerHTML=`
      ${isSel?`<circle cx="${mx}" cy="${my}" r="${r+8}" fill="${suit.color}" opacity="0.18"/>
               <circle cx="${mx}" cy="${my}" r="${r+5}" fill="none" stroke="${suit.color}" stroke-width="1.5" opacity="0.35"/>`:``}
      <circle cx="${mx}" cy="${my}" r="${r}" fill="${suit.color}" stroke="${isSel?"#0a2342":"white"}" stroke-width="${isSel?2.5:1.8}" opacity="0.92"/>
      <circle cx="${mx-r*0.25}" cy="${my-r*0.25}" r="${r*0.3}" fill="white" opacity="0.28"/>
      <g class="tip" style="display:none">
        <rect x="${mx+r+4}" y="${my-12}" width="${lw}" height="16" rx="4" fill="#0a2342" opacity="0.88"/>
        <text x="${mx+r+10}" y="${my+1}" font-size="9" fill="white" font-weight="600">${site.name}</text>
      </g>`;
    g.appendChild(el);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSite="caspar";
let currentP3Site="caspar";
let importSource=null;
let replayIdx=0;
let playInterval=null;
let charts={canopy:null,urchin:null,cumul:null,compare:null};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 1
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectSite(id){
  currentSite=id;
  renderSiteDots();
  renderP1();
}

function renderP1(){
  const site=SITES[currentSite];
  // Breadcrumb
  const bc=document.getElementById("p1-breadcrumb");
  bc.innerHTML=Object.values(SITES).map((s,i)=>`
    ${i>0?'<span class="sep">¬∑</span>':''}
    <span class="crumb ${s.id===currentSite?'active':''}" onclick="selectSite('${s.id}')">${s.name.split(" ")[0]}</span>
  `).join("");
  document.getElementById("p1-sitename").textContent=site.name;
  document.getElementById("p1-sitesub").textContent=`Mendocino County ¬∑ ${site.depthRange}`;

  // Conditions tiles
  const now=site.canopy[site.canopy.length-1].ha;
  const prev=site.canopy[site.canopy.length-2].ha;
  const trend=now>prev+0.05?"‚Üë":now<prev-0.05?"‚Üì":"‚Üí";
  const trendClr=trend==="‚Üë"?"#16a34a":trend==="‚Üì"?"#dc2626":"#64748b";
  const conds=[
    {label:"Canopy",val:`${now} ha`,sub:trend,subClr:trendClr,bold:true},
    {label:"Water Temp",val:`${site.conditions.sst}¬∞F`,sub:"surface"},
    {label:"Swell",val:site.conditions.swell.split("@")[0].trim(),sub:`@ ${(site.conditions.swell.split("@")[1]||"").trim()}`},
    {label:"Visibility",val:site.conditions.visibility.split("‚Äì")[0].trim(),sub:"ft range"},
  ];
  document.getElementById("p1-condtiles").innerHTML=conds.map(c=>`
    <div class="cond-tile">
      <span class="cond-lbl">${c.label}</span>
      <div class="cond-val">${c.val}</div>
      <div class="cond-sub" style="color:${c.subClr||'var(--label)'};font-weight:${c.bold?700:400}">${c.sub}</div>
    </div>`).join("");

  // Suitability
  const suit=suitability(site);
  document.getElementById("p1-suit-label").textContent=`${suit.label} (${suit.score}/100)`;
  document.getElementById("p1-suit-label").style.color=suit.color;
  document.getElementById("p1-suit-bar").style.width=suit.score+"%";
  document.getElementById("p1-suit-bar").style.background=suit.color;
  document.getElementById("p1-suit-grid").innerHTML=[
    ["Surge",site.conditions.surge],["Wind",site.conditions.wind],
    ["Visibility",site.conditions.visibility],["Swell",site.conditions.swell]
  ].map(([k,v])=>`<div class="suit-row"><span class="sk">${k}</span><span class="sv">${v}</span></div>`).join("");

  // 90-day activity
  const rec=recentDives(site,90);
  const recUrchins=rec.reduce((s,d)=>s+Object.values(d.cells||{}).reduce((a,b)=>a+b,0),0);
  const recHrs=rec.reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0).toFixed(1);
  document.getElementById("p1-activity").innerHTML=[
    {l:"Dives",v:rec.length},{l:"Diver-Hrs",v:recHrs},{l:"Urchins Culled",v:recUrchins.toLocaleString()}
  ].map(x=>`<div class="activity-box"><div class="activity-num">${x.v}</div><div class="activity-lbl">${x.l}</div></div>`).join("");

  const last=site.dives[site.dives.length-1];
  document.getElementById("p1-lastdive").innerHTML=last?`Last dive: <strong style="color:var(--navy)">${last.date}</strong> ¬∑ ${daysSince(last.date)} days ago ¬∑ ${last.divers} divers`:"No dives recorded yet.";

  // Comments
  const comments=site.dives.slice(-3).reverse();
  document.getElementById("p1-comments").innerHTML=comments.length===0
    ?`<p style="font-size:12px;color:var(--label);font-style:italic;padding:8px 0">No recent dives logged.</p>`
    :comments.map(c=>`
      <div class="exit-card">
        <div class="exit-meta">
          <span class="exit-date">${c.date}</span>
          <span class="exit-badge" style="background:${exitColor[c.exitConditions]}18;color:${exitColor[c.exitConditions]};border:1px solid ${exitColor[c.exitConditions]}44">${c.exitConditions}</span>
        </div>
        <div class="exit-text">${c.comments}</div>
      </div>`).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 2
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let formSite=currentSite;

function renderP2Sites(){
  document.getElementById("p2-sites").innerHTML=Object.values(SITES).map(s=>`
    <div class="site-option ${s.id===formSite?'sel':''}" onclick="selectFormSite('${s.id}')">
      <div class="so-name">${s.name}</div>
      <div class="so-sub">${s.depthRange}</div>
    </div>`).join("");
  document.getElementById("form-subtitle").textContent=`${SITES[formSite].name} ¬∑ Complete after each cull dive`;
}
function selectFormSite(id){formSite=id;renderP2Sites();}

function renderCellInputs(){
  document.getElementById("cell-inputs").innerHTML=CELLS.map(c=>`
    <div class="cell-box" id="cb-${c}">
      <div class="cell-label">Cell ${c}</div>
      <input type="number" min="0" placeholder="0" id="ci-${c}" oninput="updateCellTotal()"/>
      <div class="cell-count" id="cc-${c}" style="display:none"></div>
    </div>`).join("");
}
function updateCellTotal(){
  let total=0;
  CELLS.forEach(c=>{
    const val=parseInt(document.getElementById(`ci-${c}`).value)||0;
    total+=val;
    const box=document.getElementById(`cb-${c}`);
    const cnt=document.getElementById(`cc-${c}`);
    const inp=document.getElementById(`ci-${c}`);
    if(val>0){
      box.classList.add("has-val");
      cnt.style.display="block";
      cnt.textContent=`${val} urchins`;
      inp.style.background="white";
      box.style.background=`rgba(14,116,144,${0.04+Math.min(val/300,1)*0.22})`;
    }else{
      box.classList.remove("has-val");
      cnt.style.display="none";
      inp.style.background="#fafafa";
      box.style.background="rgba(14,116,144,0.04)";
    }
  });
  document.getElementById("cell-total").textContent=`${total.toLocaleString()} urchins`;
}

let importing=false;
function simulateImport(src){
  if(importing)return;
  importing=true;
  const btns=document.querySelectorAll(".import-btn");
  btns.forEach(b=>{b.classList.add("uploading");b.querySelector(".ib-title").textContent="‚è≥ Importing‚Ä¶";});
  setTimeout(()=>{
    importing=false;
    importSource=src;
    btns.forEach((b,i)=>{
      b.classList.remove("uploading");
      const titles=["ü§ø Garmin / Suunto Watch","üì± PADI Dive Log App","üåä Subsurface / DiveLogs","üìé Upload UDDF / CSV / FIT"];
      b.querySelector(".ib-title").textContent=titles[i]||"üìé Upload UDDF / CSV / FIT";
    });
    const succ=document.getElementById("import-success");
    succ.style.display="block";
    succ.textContent=`‚úì Imported from ${src}`;
    const tag=document.getElementById("import-tag");
    tag.textContent=`‚úì Auto-filled ¬∑ ${src}`;
    tag.style.color="#14532d";
    tag.style.background="#f0fdf4";
    tag.style.padding="2px 8px";
    tag.style.borderRadius="10px";
    tag.style.border="1px solid #86efac";
    // Fill fields
    ["f-date","f-depth","f-time","f-temp"].forEach(id=>{
      const el=document.getElementById(id);
      if(id==="f-date")el.value="2024-06-25";
      else if(id==="f-depth")el.value="31";
      else if(id==="f-time")el.value="52";
      else el.value="54";
      el.classList.add("autofilled");
    });
  },1200);
}

function submitForm(){
  const total=CELLS.reduce((s,c)=>s+(parseInt(document.getElementById(`ci-${c}`).value)||0),0);
  const date=document.getElementById("f-date").value||"unknown date";
  const exit=document.getElementById("f-exit").value;
  document.getElementById("form-inner").style.display="none";
  const ss=document.getElementById("success-screen");
  ss.classList.add("show");
  document.getElementById("success-msg").innerHTML=`<strong style="color:var(--navy)">${total.toLocaleString()}</strong> urchins removed at <strong style="color:var(--navy)">${SITES[formSite].name}</strong> on ${date}. Exit conditions: <strong style="color:var(--navy)">${exit}</strong>.`;
}
function resetForm(){
  document.getElementById("form-inner").style.display="block";
  document.getElementById("success-screen").classList.remove("show");
  importSource=null;
  ["f-name","f-email","f-group","f-date","f-depth","f-time","f-temp","f-vis","f-comments"].forEach(id=>{
    const el=document.getElementById(id);if(el)el.value="";el&&el.classList.remove("autofilled");
  });
  const tag=document.getElementById("import-tag");
  tag.textContent="Use import ‚Üê to auto-fill";tag.style.cssText="font-size:10px;color:var(--label);font-style:italic;";
  const succ=document.getElementById("import-success");succ.style.display="none";
  CELLS.forEach(c=>{document.getElementById(`ci-${c}`).value="";});
  updateCellTotal();
  document.getElementById("import-success").style.display="none";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE 3
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectP3Site(id){
  currentP3Site=id;
  document.querySelectorAll(".site-tab").forEach(b=>b.classList.toggle("active",b.dataset.site===id));
  replayIdx=SITES[id].canopy.length-1;
  stopPlay();
  renderP3();
}

function renderP3Tabs(){
  const wrap=document.getElementById("p3-tabs");
  const exportBtns=wrap.querySelector(".export-btns");
  wrap.innerHTML="";
  Object.values(SITES).forEach(s=>{
    const b=document.createElement("button");
    b.className="site-tab"+(s.id===currentP3Site?" active":"");
    b.dataset.site=s.id;
    b.textContent=s.name;
    b.onclick=()=>selectP3Site(s.id);
    wrap.appendChild(b);
  });
  wrap.appendChild(exportBtns);
}

function renderCellMap(){
  const site=SITES[currentP3Site];
  const cells=site.cellGrid;
  const totals=cellTotals(site);
  const maxU=Math.max(...Object.values(totals),1);
  const W=240,H=190;
  const lats=Object.values(cells).map(c=>c.lat);
  const lngs=Object.values(cells).map(c=>c.lng);
  const latMin=Math.min(...lats)-0.0015,latMax=Math.max(...lats)+0.0015;
  const lngMin=Math.min(...lngs)-0.002,lngMax=Math.max(...lngs)+0.002;
  function cp(lat,lng){return[((lng-lngMin)/(lngMax-lngMin)*W).toFixed(1),(H-((lat-latMin)/(latMax-latMin)*H)).toFixed(1)];}
  const svg=document.getElementById("cell-map-svg");
  svg.innerHTML=`<rect width="${W}" height="${H}" fill="#c8e6f4" rx="8"/>`;
  CELLS.forEach(c=>{
    const pos=cells[c];if(!pos)return;
    const[cx,cy]=cp(pos.lat,pos.lng);
    const intensity=totals[c]/maxU;
    const sz=20+intensity*16;
    const fill=`rgba(14,116,144,${(0.1+intensity*0.85).toFixed(2)})`;
    svg.innerHTML+=`
      <rect x="${parseFloat(cx)-sz/2}" y="${parseFloat(cy)-sz/2}" width="${sz}" height="${sz}" rx="4" fill="${fill}" stroke="white" stroke-width="1.5"/>
      <text x="${cx}" y="${parseFloat(cy)+4}" text-anchor="middle" font-size="10" fill="white" font-weight="700">${c}</text>
      ${totals[c]>0?`<text x="${cx}" y="${parseFloat(cy)+sz/2+12}" text-anchor="middle" font-size="7.5" fill="#0e7490" font-weight="600">${totals[c].toLocaleString()}</text>`:""}`;
  });
  svg.innerHTML+=`<text x="${W/2}" y="${H-4}" text-anchor="middle" font-size="8" fill="#4488a8" opacity="0.7">Cell size ‚àù urchins removed</text>`;
  document.getElementById("p3-cell-title").textContent=`Cell Activity ‚Äî ${site.name}`;
  const t=cellTotals(site);
  document.getElementById("p3-cell-totals").innerHTML=CELLS.map(c=>`
    <div class="ct-box"><div class="ct-lbl">Cell ${c}</div><div class="ct-val">${(t[c]||0).toLocaleString()}</div></div>`).join("");
}

function renderReplayMap(){
  const site=SITES[currentP3Site];
  const snap=site.canopy[Math.min(replayIdx,site.canopy.length-1)];
  const first=site.canopy[0];
  const intensity=Math.min(1,(snap.ha-first.ha)/6);
  const died=site.canopyDied||[];
  const W=240,H=180;
  const[mx,my]=proj(site.lat,site.lng);
  const sx=(mx*(W/MAP_W)).toFixed(1);
  const sy=(my*(H/MAP_H)).toFixed(1);
  const r=(8+intensity*30).toFixed(1);
  const svg=document.getElementById("replay-svg");
  svg.innerHTML=`
    <rect width="${W}" height="${H}" fill="#c8e6f4" rx="8"/>
    ${died.length>0?`<circle cx="${sx}" cy="${sy}" r="28" fill="#94a3b8" opacity="0.30"/>
    <text x="${parseFloat(sx)+32}" y="${parseFloat(sy)-6}" text-anchor="start" font-size="7.5" fill="#64748b">Lost area ‚Üó</text>`:""}
    <circle cx="${sx}" cy="${sy}" r="${r}" fill="rgba(22,163,74,${(0.15+intensity*0.5).toFixed(2)})" stroke="#16a34a" stroke-width="1.5"/>
    <circle cx="${sx}" cy="${sy}" r="6" fill="#16a34a" opacity="0.9"/>
    <text x="${sx}" y="${parseFloat(sy)+parseFloat(r)+14}" text-anchor="middle" font-size="9" fill="#16a34a" font-weight="700">${snap.ha} ha</text>
    <text x="${sx}" y="${parseFloat(sy)-16}" text-anchor="middle" font-size="9" fill="#0a2342" font-weight="700">${snap.m}</text>
    <text x="${W/2}" y="${H-5}" text-anchor="middle" font-size="7.5" fill="#4488a8" opacity="0.7">${site.name}</text>`;

  const slider=document.getElementById("replay-slider");
  slider.max=site.canopy.length-1;
  slider.value=replayIdx;
  document.getElementById("rt-start").textContent=site.canopy[0].m;
  document.getElementById("rt-cur").textContent=snap.m;
  document.getElementById("rt-end").textContent=site.canopy[site.canopy.length-1].m;
}

function onSlider(val){stopPlay();replayIdx=parseInt(val);renderReplayMap();}

function togglePlay(){
  const btn=document.getElementById("play-btn");
  if(playInterval){stopPlay();}
  else{
    replayIdx=0;
    btn.textContent="‚èπ Stop";btn.classList.add("stop");
    playInterval=setInterval(()=>{
      replayIdx++;
      if(replayIdx>=SITES[currentP3Site].canopy.length){stopPlay();return;}
      renderReplayMap();
    },700);
    renderReplayMap();
  }
}
function stopPlay(){
  if(playInterval){clearInterval(playInterval);playInterval=null;}
  const btn=document.getElementById("play-btn");
  btn.textContent="‚ñ∂ Play";btn.classList.remove("stop");
}

function destroyChart(key){if(charts[key]){charts[key].destroy();charts[key]=null;}}

function renderCanopyChart(){
  const site=SITES[currentP3Site];
  destroyChart("canopy");
  document.getElementById("p3-canopy-title").textContent=`Canopy Recovery ‚Äî Full History (${site.canopy[0].m} ‚Äì ${site.canopy[site.canopy.length-1].m})`;
  const ctx=document.getElementById("canopy-chart").getContext("2d");
  const diveMonths=new Set(site.dives.map(d=>{
    const dt=new Date(d.date);
    return dt.toLocaleString("en-US",{month:"short",year:"2-digit"}).replace(" "," ");
  }));
  charts.canopy=new Chart(ctx,{
    type:"line",
    data:{labels:site.canopy.map(x=>x.m),datasets:[{label:"Canopy (ha)",data:site.canopy.map(x=>x.ha),borderColor:"#16a34a",backgroundColor:"rgba(22,163,74,0.12)",borderWidth:2.5,pointRadius:4,pointBackgroundColor:"#16a34a",fill:true,tension:0.3}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"#0a2342",titleColor:"#fff",bodyColor:"#fff",borderWidth:0,padding:8}},scales:{x:{grid:{display:false},ticks:{font:{size:9},color:"#94a3b8",maxRotation:45}},y:{grid:{color:"#f1f5f9"},ticks:{font:{size:9},color:"#94a3b8",callback:v=>`${v}ha`}}},
    plugins:[{afterDraw(chart){
      const{ctx,scales}=chart;
      site.dives.forEach(d=>{
        const dt=new Date(d.date);
        const label=dt.toLocaleString("en-US",{month:"short",year:"2-digit"}).replace(" "," ");
        const idx=site.canopy.findIndex(x=>x.m===label);
        if(idx<0)return;
        const x=scales.x.getPixelForValue(idx);
        ctx.save();ctx.strokeStyle="rgba(14,116,144,0.35)";ctx.lineWidth=1;ctx.setLineDash([]);
        ctx.beginPath();ctx.moveTo(x,scales.y.top);ctx.lineTo(x,scales.y.bottom);ctx.stroke();ctx.restore();
      });
    }}]}
  });
}

function renderUrchinChart(){
  const site=SITES[currentP3Site];
  destroyChart("urchin");
  const ctx=document.getElementById("urchin-chart").getContext("2d");
  if(!site.dives.length){
    const c=new Chart(ctx,{type:"bar",data:{labels:["No data"],datasets:[{data:[0],backgroundColor:"#e2e8f0"}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
    charts.urchin=c;return;
  }
  const labels=site.dives.map(d=>d.date.slice(0,7));
  const urchins=site.dives.map(d=>Object.values(d.cells||{}).reduce((a,b)=>a+b,0));
  const hrs=site.dives.map(d=>parseFloat((d.divers*d.bottomTime/60).toFixed(1)));
  charts.urchin=new Chart(ctx,{
    type:"bar",
    data:{labels,datasets:[{label:"Urchins culled",data:urchins,backgroundColor:"rgba(14,116,144,0.85)",borderRadius:3},{label:"Diver-hrs",data:hrs,backgroundColor:"rgba(77,124,15,0.55)",borderRadius:3}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{size:10},boxWidth:8}},tooltip:{backgroundColor:"#0a2342",titleColor:"#fff",bodyColor:"#fff"}},scales:{x:{grid:{display:false},ticks:{font:{size:9},color:"#94a3b8"}},y:{grid:{color:"#f1f5f9"},ticks:{font:{size:9},color:"#94a3b8"}}}}
  });
}

function renderEfficiency(){
  const site=SITES[currentP3Site];
  const hrs=site.dives.reduce((s,d)=>s+(d.divers*d.bottomTime)/60,0).toFixed(1);
  const gain=(site.canopy[site.canopy.length-1].ha-site.canopy[0].ha).toFixed(2);
  const eff=siteEfficiency(site);
  document.getElementById("p3-eff-boxes").innerHTML=[
    {l:"Total Diver-Hrs",v:hrs,u:"hrs"},{l:"Canopy Gained",v:gain,u:"ha"},{l:"Efficiency",v:eff||"‚Äî",u:eff?"hrs/ha":""}
  ].map(x=>`<div class="eff-box"><div class="eff-num">${x.v}<span class="eff-unit">${x.u}</span></div><div class="eff-lbl">${x.l}</div></div>`).join("");

  destroyChart("cumul");
  const ctx=document.getElementById("cumul-chart").getContext("2d");
  let cum=0;
  const cuData=site.dives.map(d=>{cum+=Object.values(d.cells||{}).reduce((a,b)=>a+b,0);return cum;});
  const cuLabels=site.dives.map(d=>d.date.slice(0,7));
  if(cuLabels.length){
    charts.cumul=new Chart(ctx,{type:"line",data:{labels:cuLabels,datasets:[{label:"Cumulative urchins",data:cuData,borderColor:"#0e7490",backgroundColor:"transparent",borderWidth:2,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"#0a2342",titleColor:"#fff",bodyColor:"#fff"}},scales:{x:{grid:{display:false},ticks:{font:{size:8},color:"#94a3b8"}},y:{grid:{color:"#f1f5f9"},ticks:{font:{size:8},color:"#94a3b8"}}}}});
  }
}

function renderCompareChart(){
  destroyChart("compare");
  const ctx=document.getElementById("compare-chart").getContext("2d");
  const sites=Object.values(SITES);
  const names=sites.map(s=>s.name.split(" ")[0]);
  const gains=sites.map(s=>parseFloat((s.canopy[s.canopy.length-1].ha-s.canopy[0].ha).toFixed(2)));
  const curr=sites.map(s=>s.canopy[s.canopy.length-1].ha);
  charts.compare=new Chart(ctx,{
    type:"bar",
    data:{labels:names,datasets:[{label:"Ha gained",data:gains,backgroundColor:"rgba(22,163,74,0.85)",borderRadius:3},{label:"Current ha",data:curr,backgroundColor:"rgba(14,116,144,0.5)",borderRadius:3}]},
    options:{indexAxis:"y",responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{size:10},boxWidth:8}},tooltip:{backgroundColor:"#0a2342",titleColor:"#fff",bodyColor:"#fff"}},scales:{x:{grid:{color:"#f1f5f9"},ticks:{font:{size:9},color:"#94a3b8",callback:v=>`${v}ha`}},y:{grid:{display:false},ticks:{font:{size:10},color:"#334155"}}}}
  });
  document.getElementById("p3-compare-list").innerHTML=sites.map(s=>{
    const hrs=s.dives.reduce((sum,d)=>sum+(d.divers*d.bottomTime)/60,0).toFixed(1);
    const gain=(s.canopy[s.canopy.length-1].ha-s.canopy[0].ha).toFixed(2);
    return`<div class="site-compare-row"><span class="scn">${s.name}</span><span class="scv">${hrs}h ¬∑ ${s.dives.length} dives ¬∑ ${gain>0?"+":""}${gain} ha</span></div>`;
  }).join("");
}

function renderP3(){
  renderCellMap();
  renderReplayMap();
  renderCanopyChart();
  renderUrchinChart();
  renderEfficiency();
  renderCompareChart();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(){
  const site=SITES[currentP3Site];
  const rows=[["Date","Divers","Bottom Time","Max Depth","Water Temp","Visibility","Surge",...CELLS.map(c=>`Cell ${c}`),"Total","Comments","Exit"]];
  site.dives.forEach(d=>{const t=Object.values(d.cells||{}).reduce((a,b)=>a+b,0);rows.push([d.date,d.divers,d.bottomTime,d.maxDepth,d.waterTemp,d.visibility,d.surge,...CELLS.map(c=>d.cells?.[c]||0),t,`"${d.comments}"`,d.exitConditions]);});
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"}));a.download=`${site.id}.csv`;a.click();
}
function exportJSON(){
  const site=SITES[currentP3Site];
  const data=JSON.stringify({site:site.id,name:site.name,dives:site.dives,canopy:site.canopy,cellTotals:cellTotals(site)},null,2);
  const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));a.download=`${site.id}.json`;a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    const page=document.getElementById(btn.dataset.tab);
    page.classList.add("active");
    if(btn.dataset.tab==="p3"){renderP3Tabs();renderP3();}
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEADER STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHeaderStats(){
  const t=programTotals();
  document.getElementById("hs-hrs").innerHTML=`${t.hrs}<span class="hstat-unit">hrs</span>`;
  document.getElementById("hs-urchins").textContent=t.urchins.toLocaleString();
  document.getElementById("hs-ha").innerHTML=`${t.ha}<span class="hstat-unit">ha</span>`;
  document.getElementById("hs-dives").textContent=t.dives;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderHeaderStats();
buildMap();
renderP1();
renderP2Sites();
renderCellInputs();
</script>
</body>
</html>